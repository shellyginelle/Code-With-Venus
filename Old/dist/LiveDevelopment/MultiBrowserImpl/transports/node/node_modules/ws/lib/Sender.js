var events=require("events"),util=require("util"),EventEmitter=events.EventEmitter,ErrorCodes=require("./ErrorCodes"),bufferUtil=require("./BufferUtil").BufferUtil;function Sender(socket){this._socket=socket;this.firstFragment=true}util.inherits(Sender,events.EventEmitter);Sender.prototype.close=function(code,data,mask){if(typeof code!=="undefined"){if(typeof code!=="number"||!ErrorCodes.isValidErrorCode(code))throw new Error("first argument must be a valid error code number")}code=code||1e3;var dataBuffer=new Buffer(2+(data?Buffer.byteLength(data):0));writeUInt16BE.call(dataBuffer,code,0);if(dataBuffer.length>2)dataBuffer.write(data,2);this.frameAndSend(8,dataBuffer,true,mask)};Sender.prototype.ping=function(data,options){var mask=options&&options.mask;this.frameAndSend(9,data||"",true,mask)};Sender.prototype.pong=function(data,options){var mask=options&&options.mask;this.frameAndSend(10,data||"",true,mask)};Sender.prototype.send=function(data,options,cb){var finalFragment=options&&options.fin===false?false:true;var mask=options&&options.mask;var opcode=options&&options.binary?2:1;if(this.firstFragment===false)opcode=0;else this.firstFragment=false;if(finalFragment)this.firstFragment=true;this.frameAndSend(opcode,data,finalFragment,mask,cb)};Sender.prototype.frameAndSend=function(opcode,data,finalFragment,maskData,cb){var canModifyData=false;if(!data){try{this._socket.write(new Buffer([opcode|(finalFragment?128:0),0|(maskData?128:0)].concat(maskData?[0,0,0,0]:[])),"binary",cb)}catch(e){if(typeof cb=="function")cb(e);else this.emit("error",e)}return}if(!Buffer.isBuffer(data)){canModifyData=true;if(data&&(typeof data.byteLength!=="undefined"||typeof data.buffer!=="undefined")){data=getArrayBuffer(data)}else{data=new Buffer(data)}}var dataLength=data.length,dataOffset=maskData?6:2,secondByte=dataLength;if(dataLength>=65536){dataOffset+=8;secondByte=127}else if(dataLength>125){dataOffset+=2;secondByte=126}var mergeBuffers=dataLength<32768||maskData&&!canModifyData;var totalLength=mergeBuffers?dataLength+dataOffset:dataOffset;var outputBuffer=new Buffer(totalLength);outputBuffer[0]=finalFragment?opcode|128:opcode;switch(secondByte){case 126:writeUInt16BE.call(outputBuffer,dataLength,2);break;case 127:writeUInt32BE.call(outputBuffer,0,2);writeUInt32BE.call(outputBuffer,dataLength,6)}if(maskData){outputBuffer[1]=secondByte|128;var mask=this._randomMask||(this._randomMask=getRandomMask());outputBuffer[dataOffset-4]=mask[0];outputBuffer[dataOffset-3]=mask[1];outputBuffer[dataOffset-2]=mask[2];outputBuffer[dataOffset-1]=mask[3];if(mergeBuffers){bufferUtil.mask(data,mask,outputBuffer,dataOffset,dataLength);try{this._socket.write(outputBuffer,"binary",cb)}catch(e){if(typeof cb=="function")cb(e);else this.emit("error",e)}}else{bufferUtil.mask(data,mask,data,0,dataLength);try{this._socket.write(outputBuffer,"binary");this._socket.write(data,"binary",cb)}catch(e){if(typeof cb=="function")cb(e);else this.emit("error",e)}}}else{outputBuffer[1]=secondByte;if(mergeBuffers){data.copy(outputBuffer,dataOffset);try{this._socket.write(outputBuffer,"binary",cb)}catch(e){if(typeof cb=="function")cb(e);else this.emit("error",e)}}else{try{this._socket.write(outputBuffer,"binary");this._socket.write(data,"binary",cb)}catch(e){if(typeof cb=="function")cb(e);else this.emit("error",e)}}}};module.exports=Sender;function writeUInt16BE(value,offset){this[offset]=(value&65280)>>8;this[offset+1]=value&255}function writeUInt32BE(value,offset){this[offset]=(value&4278190080)>>24;this[offset+1]=(value&16711680)>>16;this[offset+2]=(value&65280)>>8;this[offset+3]=value&255}function getArrayBuffer(data){var array=new Uint8Array(data.buffer||data),l=data.byteLength||data.length,o=data.byteOffset||0,buffer=new Buffer(l);for(var i=0;i<l;++i){buffer[i]=array[o+i]}return buffer}function getRandomMask(){return new Buffer([~~(Math.random()*255),~~(Math.random()*255),~~(Math.random()*255),~~(Math.random()*255)])}