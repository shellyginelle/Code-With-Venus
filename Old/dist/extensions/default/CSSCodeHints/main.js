define(function(require,exports,module){"use strict";var AppInit=brackets.getModule("utils/AppInit"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),CodeHintManager=brackets.getModule("editor/CodeHintManager"),CSSUtils=brackets.getModule("language/CSSUtils"),HTMLUtils=brackets.getModule("language/HTMLUtils"),LanguageManager=brackets.getModule("language/LanguageManager"),TokenUtils=brackets.getModule("utils/TokenUtils"),StringMatch=brackets.getModule("utils/StringMatch"),ColorUtils=brackets.getModule("utils/ColorUtils"),CSSProperties=require("text!CSSProperties.json"),properties=JSON.parse(CSSProperties);var lastContext,stringMatcherOptions={preferPrefixMatches:true};function CssPropHints(){this.primaryTriggerKeys="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-()";this.secondaryTriggerKeys=":";this.exclusion=null}CssPropHints.prototype.getCssStyleText=function(){if(LanguageManager.getLanguageForPath(this.editor.document.file.fullPath).getId()==="html"){var text="",styleBlocks=HTMLUtils.findBlocks(this.editor,"css");styleBlocks.forEach(function(styleBlock){text+=styleBlock.text});return text}else{return this.editor.document.getText()}};CssPropHints.prototype.getNamedFlows=function(){if(this.namedFlowsCache){if(this.namedFlowsCache.cursor.line!==this.cursor.line){this.namedFlowsCache=null}}if(!this.namedFlowsCache){this.namedFlowsCache={};this.namedFlowsCache.flows=CSSUtils.extractAllNamedFlows(this.getCssStyleText());this.namedFlowsCache.cursor={line:this.cursor.line,ch:this.cursor.ch}}return this.namedFlowsCache.flows};CssPropHints.prototype.updateExclusion=function(propNameOnly){var textAfterCursor;if(this.exclusion&&this.info){if(this.info.context===CSSUtils.PROP_NAME){textAfterCursor=this.info.name.substr(this.info.offset)}else if(!propNameOnly&&this.info.context===CSSUtils.PROP_VALUE){textAfterCursor=this.info.value.substr(this.info.offset)}if(!CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){this.exclusion=null}}};CssPropHints.prototype.hasHints=function(editor,implicitChar){this.editor=editor;var cursor=this.editor.getCursorPos();lastContext=null;this.info=CSSUtils.getInfoAtPos(editor,cursor);if(this.info.context!==CSSUtils.PROP_NAME&&this.info.context!==CSSUtils.PROP_VALUE){return false}if(implicitChar){this.updateExclusion(false);if(this.info.context===CSSUtils.PROP_NAME){if(!this.exclusion&&this.info.offset===1&&implicitChar===this.info.name[0]){this.exclusion=this.info.name.substr(this.info.offset)}}return this.primaryTriggerKeys.indexOf(implicitChar)!==-1||this.secondaryTriggerKeys.indexOf(implicitChar)!==-1}else if(this.info.context===CSSUtils.PROP_NAME){if(this.info.offset===0){this.exclusion=this.info.name}else{this.updateExclusion(true)}}return true};function formatHints(hints,query){var hasColorSwatch=hints.some(function(token){return token.color});StringMatch.basicMatchSort(hints);return hints.map(function(token){var $hintObj=$("<span>").addClass("brackets-css-hints");if(token.stringRanges){token.stringRanges.forEach(function(item){if(item.matched){$hintObj.append($("<span>").text(item.text).addClass("matched-hint"))}else{$hintObj.append(item.text)}})}else{$hintObj.text(token.value)}if(hasColorSwatch){$hintObj=ColorUtils.formatColorHint($hintObj,token.color)}return $hintObj})}CssPropHints.prototype.getHints=function(implicitChar){this.cursor=this.editor.getCursorPos();this.info=CSSUtils.getInfoAtPos(this.editor,this.cursor);var needle=this.info.name,valueNeedle="",context=this.info.context,valueArray,type,namedFlows,result,selectInitial=false;this.updateExclusion(true);if(context===CSSUtils.PROP_VALUE){selectInitial=true;if(implicitChar==="("){return true}if(lastContext===CSSUtils.PROP_NAME){return true}else{lastContext=CSSUtils.PROP_VALUE}if(!properties[needle]){return null}if(!this.info.isNewItem&&this.info.index!==-1){valueNeedle=this.info.values[this.info.index].trim();valueNeedle=valueNeedle.substr(0,this.info.offset)}valueArray=properties[needle].values;type=properties[needle].type;if(type==="named-flow"){namedFlows=this.getNamedFlows();if(valueNeedle.length===this.info.offset&&namedFlows.indexOf(valueNeedle)!==-1){namedFlows.splice(namedFlows.indexOf(valueNeedle),1)}valueArray=valueArray.concat(namedFlows)}else if(type==="color"){valueArray=valueArray.concat(ColorUtils.COLOR_NAMES.map(function(color){return{text:color,color:color}}));valueArray.push("transparent","currentColor")}result=$.map(valueArray,function(pvalue){var result=StringMatch.stringMatch(pvalue.text||pvalue,valueNeedle,stringMatcherOptions);if(result){if(pvalue.color){result.color=pvalue.color}return result}});return{hints:formatHints(result,valueNeedle),match:null,selectInitial:selectInitial}}else if(context===CSSUtils.PROP_NAME){if(this.primaryTriggerKeys.indexOf(implicitChar)!==-1||needle!==""){selectInitial=true}lastContext=CSSUtils.PROP_NAME;needle=needle.substr(0,this.info.offset);result=$.map(properties,function(pvalues,pname){var result=StringMatch.stringMatch(pname,needle,stringMatcherOptions);if(result){return result}});return{hints:formatHints(result,needle),match:null,selectInitial:selectInitial,handleWideResults:false}}return null};CssPropHints.prototype.insertHint=function(hint){var offset=this.info.offset,cursor=this.editor.getCursorPos(),start={line:-1,ch:-1},end={line:-1,ch:-1},keepHints=false,adjustCursor=false,newCursor,ctx;if(hint.jquery){hint=hint.text()}if(this.info.context!==CSSUtils.PROP_NAME&&this.info.context!==CSSUtils.PROP_VALUE){return false}start.line=end.line=cursor.line;start.ch=cursor.ch-offset;if(this.info.context===CSSUtils.PROP_NAME){keepHints=true;var textAfterCursor=this.info.name.substr(this.info.offset);if(this.info.name.length===0||CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){hint+=": ";end.ch=start.ch;end.ch+=offset;if(this.exclusion){hint+=" ";adjustCursor=true;newCursor={line:cursor.line,ch:start.ch+hint.length-1};this.exclusion=null}}else{end.ch=start.ch+this.info.name.length;ctx=TokenUtils.getInitialContext(this.editor._codeMirror,cursor);if(ctx.token.string.length>0&&!/\S/.test(ctx.token.string)){TokenUtils.moveNextToken(ctx)}if(TokenUtils.moveSkippingWhitespace(TokenUtils.moveNextToken,ctx)&&ctx.token.string===":"){adjustCursor=true;newCursor={line:cursor.line,ch:cursor.ch+(hint.length-this.info.name.length)};if(TokenUtils.moveNextToken(ctx)&&ctx.token.string.length>0&&!/\S/.test(ctx.token.string)){newCursor.ch+=ctx.token.string.length}}else{hint+=": "}}}else{if(!this.info.isNewItem&&this.info.index!==-1){end.ch=start.ch+this.info.values[this.info.index].length}else{end.ch=start.ch}var parenMatch=hint.match(/\(.*?\)/);if(parenMatch){adjustCursor=true;newCursor={line:cursor.line,ch:start.ch+parenMatch.index+1};keepHints=true}}this.editor._codeMirror.replaceRange(hint,start,end);if(adjustCursor){this.editor.setCursorPos(newCursor)}return keepHints};AppInit.appReady(function(){var cssPropHints=new CssPropHints;CodeHintManager.registerHintProvider(cssPropHints,["css","scss","less"],0);ExtensionUtils.loadStyleSheet(module,"styles/brackets-css-hints.css");exports.cssPropHintProvider=cssPropHints})});