define(function(require,exports,module){"use strict";var SpecRunnerUtils=brackets.getModule("spec/SpecRunnerUtils");var testWindow,PreferencesManager;describe("HealthData",function(){beforeEach(function(){SpecRunnerUtils.createTestWindowAndRun(this,function(w){testWindow=w})});afterEach(function(){SpecRunnerUtils.closeTestWindow();testWindow=null});describe("Data Send to Server",function(){var ONE_DAY=24*60*60*1e3,FIRST_LAUNCH_SEND_DELAY=30*60*1e3,prefs,HealthDataManager;beforeEach(function(){PreferencesManager=testWindow.brackets.test.PreferencesManager;prefs=PreferencesManager.getExtensionPrefs("healthData");HealthDataManager=testWindow.brackets.test.HealthDataManager;this.addMatchers({toBeGreaterOrEqualTo:function(expected){this.message=function(){return"Expected "+this.actual+" to be >= "+expected};return this.actual>=expected}})});afterEach(function(){HealthDataManager=null;prefs=null;PreferencesManager=null});it("should send data to server when opted in",function(){var baseTime=Date.now();PreferencesManager.setViewState("nextHealthDataSendTime",baseTime);PreferencesManager.setViewState("healthDataNotificationShown",true);var promise=HealthDataManager.checkHealthDataSend();waitsForDone(promise,"Send Data to Server",4e3);expect(PreferencesManager.getViewState("nextHealthDataSendTime")).toBeGreaterOrEqualTo(baseTime+ONE_DAY)});it("should not send data right away on first launch",function(){var baseTime=Date.now();PreferencesManager.setViewState("nextHealthDataSendTime",null);PreferencesManager.setViewState("healthDataNotificationShown",true);var promise=HealthDataManager.checkHealthDataSend();waitsForFail(promise,"Send Data to Server",4e3);expect(PreferencesManager.getViewState("nextHealthDataSendTime")).toBeGreaterOrEqualTo(baseTime+FIRST_LAUNCH_SEND_DELAY)});it("should not send data to server when opted out",function(){PreferencesManager.setViewState("nextHealthDataSendTime",Date.now());prefs.set("healthDataTracking",false);var promise=HealthDataManager.checkHealthDataSend();waitsForFail(promise,"Send Data to Server",4e3)})});describe("Notification popup",function(){var HealthDataPopup;beforeEach(function(){HealthDataPopup=testWindow.brackets.test.HealthDataPopup});afterEach(function(){HealthDataPopup=null});it("should show notification popup",function(){HealthDataPopup.showFirstLaunchTooltip();expect($(testWindow.document).find("#healthdata-firstlaunch-popup").length).toBe(1)})});describe("Health Data Statistics is displayed",function(){var HealthDataPreview;beforeEach(function(){HealthDataPreview=testWindow.brackets.test.HealthDataPreview});afterEach(function(){HealthDataPreview=null});it("should show file preview dialog",function(){runs(function(){var promise=HealthDataPreview.previewHealthData();waitsForDone(promise,"Health Data File Preview",4e3)});runs(function(){expect($(testWindow.document).find(".health-data-preview.instance").length).toBe(1)})})})})});