define(function(require,exports,module){"use strict";var KeyEvent=brackets.getModule("utils/KeyEvent"),Strings=brackets.getModule("strings");var TimingFunctionUtils=require("TimingFunctionUtils");var BezierCurveEditorTemplate=require("text!BezierCurveEditorTemplate.html");var HEIGHT_ABOVE=75,HEIGHT_BELOW=75,HEIGHT_MAIN=150,WIDTH_MAIN=150;var animationRequest=null;function CubicBezier(coordinates){if(typeof coordinates==="string"){this.coordinates=coordinates.split(",")}else{this.coordinates=coordinates}if(!this.coordinates){throw"No offsets were defined"}this.coordinates=this.coordinates.map(function(n){return+n});var i;for(i=3;i>=0;i--){var xy=this.coordinates[i];if(isNaN(xy)||i%2===0&&(xy<0||xy>1)){throw"Wrong coordinate at "+i+"("+xy+")"}}}function BezierCanvas(canvas,bezier,padding){this.canvas=canvas;this.bezier=bezier;this.padding=this.getPadding(padding);var ctx=this.canvas.getContext("2d"),p=this.padding;ctx.scale(canvas.width*(1-p[1]-p[3]),-canvas.height*.5*(1-p[0]-p[2]));ctx.translate(p[3]/(1-p[1]-p[3]),-1-p[0]/(1-p[0]-p[2])-.5)}BezierCanvas.prototype={getOffsets:function(){var p=this.padding,w=this.canvas.width,h=this.canvas.height*.5;return[{left:w*(this.bezier.coordinates[0]*(1-p[3]-p[1])-p[3])+"px",top:h*(1-this.bezier.coordinates[1]*(1-p[0]-p[2])-p[0])+"px"},{left:w*(this.bezier.coordinates[2]*(1-p[3]-p[1])-p[3])+"px",top:h*(1-this.bezier.coordinates[3]*(1-p[0]-p[2])-p[0])+"px"}]},prettify:function(v){return(Math.round(v*100)/100).toString().replace(/^0\./,".")},offsetsToCoordinates:function(element){var p=this.padding,w=this.canvas.width,h=this.canvas.height*.5;p=p.map(function(a,i){return a*(i%2?w:h)});return[this.prettify((parseInt($(element).css("left"),10)-p[3])/(w+p[1]+p[3])),this.prettify((h-parseInt($(element).css("top"),10)-p[2])/(h-p[0]-p[2]))]},plot:function(settings){var xy=this.bezier.coordinates,ctx=this.canvas.getContext("2d"),setting;var defaultSettings={handleTimingFunction:"#2893ef",handleThickness:.008,vBorderThickness:.02,hBorderThickness:.01,bezierTimingFunction:"#2893ef",bezierThickness:.03};settings=settings||{};for(setting in defaultSettings){if(defaultSettings.hasOwnProperty(setting)){if(!settings.hasOwnProperty(setting)){settings[setting]=defaultSettings[setting]}}}ctx.clearRect(-.5,-.5,2,2);ctx.beginPath();ctx.fillStyle=settings.handleTimingFunction;ctx.lineWidth=settings.handleThickness;ctx.strokeStyle=settings.handleTimingFunction;ctx.moveTo(0,0);ctx.lineTo(xy[0],xy[1]);ctx.moveTo(1,1);ctx.lineTo(xy[2],xy[3]);ctx.stroke();ctx.closePath();ctx.beginPath();ctx.arc(xy[0],xy[1],1.5*settings.handleThickness,0,2*Math.PI,false);ctx.closePath();ctx.fill();ctx.beginPath();ctx.arc(xy[2],xy[3],1.5*settings.handleThickness,0,2*Math.PI,false);ctx.closePath();ctx.fill();ctx.beginPath();ctx.lineWidth=settings.bezierThickness;ctx.strokeStyle=settings.bezierColor;ctx.moveTo(0,0);ctx.bezierCurveTo(xy[0],xy[1],xy[2],xy[3],1,1);ctx.stroke();ctx.closePath()},getPadding:function(padding){var p=typeof padding==="number"?[padding]:padding;if(p.length===1){p[1]=p[0]}if(p.length===2){p[2]=p[0]}if(p.length===3){p[3]=p[1]}return p}};function _curveClick(e){var self=e.target,bezierEditor=self.bezierEditor;var curveBoundingBox=bezierEditor._getCurveBoundingBox(),left=curveBoundingBox.left,top=curveBoundingBox.top,x=e.pageX-left,y=e.pageY-top-HEIGHT_ABOVE,$P1=$(bezierEditor.P1),$P2=$(bezierEditor.P2);function distance(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))}var distP1=distance(x,y,parseInt($P1.css("left"),10),parseInt($P1.css("top"),10)),distP2=distance(x,y,parseInt($P2.css("left"),10),parseInt($P2.css("top"),10)),$P=distP1<distP2?$P1:$P2;$P.css({left:x+"px",top:y+"px"});$P.get(0).focus();bezierEditor._cubicBezierCoords=bezierEditor.bezierCanvas.offsetsToCoordinates(bezierEditor.P1).concat(bezierEditor.bezierCanvas.offsetsToCoordinates(bezierEditor.P2));bezierEditor._commitTimingFunction();bezierEditor._updateCanvas()}function handlePointMove(e,x,y){var self=e.target,bezierEditor=self.bezierEditor;function mouseMoveRedraw(){if(!bezierEditor.dragElement){animationRequest=null;return}bezierEditor._commitTimingFunction();bezierEditor._updateCanvas();animationRequest=window.requestAnimationFrame(mouseMoveRedraw)}if(bezierEditor.dragElement&&e.which!==1){bezierEditor.dragElement=null;bezierEditor._commitTimingFunction();bezierEditor._updateCanvas();bezierEditor=null;return}x=Math.min(Math.max(0,x),WIDTH_MAIN);if(bezierEditor.dragElement){$(bezierEditor.dragElement).css({left:x+"px",top:y+"px"})}bezierEditor._cubicBezierCoords=bezierEditor.bezierCanvas.offsetsToCoordinates(bezierEditor.P1).concat(bezierEditor.bezierCanvas.offsetsToCoordinates(bezierEditor.P2));if(!animationRequest){animationRequest=window.requestAnimationFrame(mouseMoveRedraw)}}function updateTimeProgression(curve,x,y){var percentX=Math.round(100*x/WIDTH_MAIN),percentY=Math.round(100*((HEIGHT_MAIN-y)/HEIGHT_MAIN));percentX=Math.min(Math.max(0,percentX),100);curve.parentNode.setAttribute("data-time",percentX);curve.parentNode.setAttribute("data-progression",percentY)}function _curveMouseMove(e){var self=e.target,bezierEditor=self.bezierEditor,curveBoundingBox=bezierEditor._getCurveBoundingBox(),left=curveBoundingBox.left,top=curveBoundingBox.top,x=e.pageX-left,y=e.pageY-top-HEIGHT_ABOVE;updateTimeProgression(self,x,y);if(bezierEditor.dragElement){if(e.pageX===0&&e.pageY===0){return}handlePointMove(e,x,y)}}function _pointMouseMove(e){var self=e.target,bezierEditor=self.bezierEditor,curveBoundingBox=bezierEditor._getCurveBoundingBox(),left=curveBoundingBox.left,top=curveBoundingBox.top,x=e.pageX-left,y=e.pageY-top-HEIGHT_ABOVE;updateTimeProgression(bezierEditor.curve,x,y);if(e.pageX===0&&e.pageY===0){return}handlePointMove(e,x,y)}function _pointMouseDown(e){var self=e.target;self.bezierEditor.dragElement=self}function _pointMouseUp(e){var self=e.target;self.focus();if(self.bezierEditor.dragElement){self.bezierEditor.dragElement=null;self.bezierEditor._commitTimingFunction();self.bezierEditor._updateCanvas()}}function _pointKeyDown(e){var code=e.keyCode,self=e.target,bezierEditor=self.bezierEditor;if(code>=KeyEvent.DOM_VK_LEFT&&code<=KeyEvent.DOM_VK_DOWN){e.preventDefault();var $this=$(e.target),left=parseInt($this.css("left"),10),top=parseInt($this.css("top"),10),offset=e.shiftKey?15:3,newVal;switch(code){case KeyEvent.DOM_VK_LEFT:newVal=Math.max(0,left-offset);if(left===newVal){return false}$this.css({left:newVal+"px"});break;case KeyEvent.DOM_VK_UP:newVal=Math.max(-HEIGHT_ABOVE,top-offset);if(top===newVal){return false}$this.css({top:newVal+"px"});break;case KeyEvent.DOM_VK_RIGHT:newVal=Math.min(WIDTH_MAIN,left+offset);if(left===newVal){return false}$this.css({left:newVal+"px"});break;case KeyEvent.DOM_VK_DOWN:newVal=Math.min(HEIGHT_MAIN+HEIGHT_BELOW,top+offset);if(top===newVal){return false}$this.css({top:newVal+"px"});break}bezierEditor._cubicBezierCoords=bezierEditor.bezierCanvas.offsetsToCoordinates(bezierEditor.P1).concat(bezierEditor.bezierCanvas.offsetsToCoordinates(bezierEditor.P2));bezierEditor._commitTimingFunction();bezierEditor._updateCanvas();return true}else if(code===KeyEvent.DOM_VK_ESCAPE){return true}else if(code===KeyEvent.DOM_VK_TAB&&!e.ctrlKey&&!e.metaKey&&!e.altKey){if($(e.target).hasClass("P1")){$(".P2").focus()}else{$(".P1").focus()}e.preventDefault();return true}return false}function BezierCurveEditor($parent,bezierCurve,callback){this.$element=$(Mustache.render(BezierCurveEditorTemplate,Strings));$parent.append(this.$element);this._callback=callback;this.dragElement=null;this._cubicBezierCoords=this._getCubicBezierCoords(bezierCurve);this.hint={};this.hint.elem=$(".hint",this.$element);if(bezierCurve.originalString){TimingFunctionUtils.showHideHint(this.hint,true,bezierCurve.originalString,"cubic-bezier("+this._cubicBezierCoords.join(", ")+")")}else{TimingFunctionUtils.showHideHint(this.hint,false)}this.P1=this.$element.find(".P1")[0];this.P2=this.$element.find(".P2")[0];this.curve=this.$element.find(".curve")[0];this.P1.bezierEditor=this.P2.bezierEditor=this.curve.bezierEditor=this;this.bezierCanvas=new BezierCanvas(this.curve,null,[0,0]);this._updateCanvas();$(this.curve).on("click",_curveClick).on("mousemove",_curveMouseMove);$(this.P1).on("mousemove",_pointMouseMove).on("mousedown",_pointMouseDown).on("mouseup",_pointMouseUp).on("keydown",_pointKeyDown);$(this.P2).on("mousemove",_pointMouseMove).on("mousedown",_pointMouseDown).on("mouseup",_pointMouseUp).on("keydown",_pointKeyDown)}BezierCurveEditor.prototype.destroy=function(){this.P1.bezierEditor=this.P2.bezierEditor=this.curve.bezierEditor=null;$(this.curve).off("click",_curveClick).off("mousemove",_curveMouseMove);$(this.P1).off("mousemove",_pointMouseMove).off("mousedown",_pointMouseDown).off("mouseup",_pointMouseUp).off("keydown",_pointKeyDown);$(this.P2).off("mousemove",_pointMouseMove).off("mousedown",_pointMouseDown).off("mouseup",_pointMouseUp).off("keydown",_pointKeyDown)};BezierCurveEditor.prototype.getRootElement=function(){return this.$element};BezierCurveEditor.prototype.focus=function(){this.P1.focus();return true};BezierCurveEditor.prototype._commitTimingFunction=function(){var bezierCurveVal="cubic-bezier("+this._cubicBezierCoords[0]+", "+this._cubicBezierCoords[1]+", "+this._cubicBezierCoords[2]+", "+this._cubicBezierCoords[3]+")";this._callback(bezierCurveVal);TimingFunctionUtils.showHideHint(this.hint,false)};BezierCurveEditor.prototype._getCubicBezierCoords=function(match){if(match[0].match(/^cubic-bezier/)){return match.slice(1,5)}else{switch(match[0]){case"linear":return["0","0","1","1"];case"ease":return[".25",".1",".25","1"];case"ease-in":return[".42","0","1","1"];case"ease-out":return["0","0",".58","1"];case"ease-in-out":return[".42","0",".58","1"]}}window.console.log("brackets-cubic-bezier: getCubicBezierCoords() passed invalid RegExp match array");return["0","0","0","0"]};BezierCurveEditor.prototype._getCurveBoundingBox=function(){var $canvas=this.$element.find(".curve"),canvasOffset=$canvas.offset();return{left:canvasOffset.left,top:canvasOffset.top,width:$canvas.width(),height:$canvas.height()}};BezierCurveEditor.prototype._updateCanvas=function(){if(this._cubicBezierCoords){this.bezierCanvas.bezier=window.bezier=new CubicBezier(this._cubicBezierCoords);var offsets=this.bezierCanvas.getOffsets();$(this.P1).css({left:offsets[0].left,top:offsets[0].top});$(this.P2).css({left:offsets[1].left,top:offsets[1].top});this.bezierCanvas.plot()}};BezierCurveEditor.prototype.handleExternalUpdate=function(bezierCurve){this._cubicBezierCoords=this._getCubicBezierCoords(bezierCurve);this._updateCanvas();if(bezierCurve.originalString){TimingFunctionUtils.showHideHint(this.hint,true,bezierCurve.originalString,"cubic-bezier("+this._cubicBezierCoords.join(", ")+")")}else{TimingFunctionUtils.showHideHint(this.hint,false)}};exports.BezierCurveEditor=BezierCurveEditor});