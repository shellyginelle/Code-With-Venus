define(function(require,exports,module){"use strict";var _=brackets.getModule("thirdparty/lodash");var Commands=brackets.getModule("command/Commands"),CommandManager=brackets.getModule("command/CommandManager"),KeyEvent=brackets.getModule("utils/KeyEvent"),Menus=brackets.getModule("command/Menus"),Strings=brackets.getModule("strings"),HintsUtils2=require("HintUtils2"),ScopeManager=require("ScopeManager");var SHOW_PARAMETER_HINT_CMD_ID="showParameterHint",PUSH_EXISTING_HINT=true,OVERWRITE_EXISTING_HINT=false,hintContainerHTML=require("text!ParameterHintTemplate.html"),KeyboardPrefs=JSON.parse(require("text!keyboard.json"));var $hintContainer,$hintContent,hintState={},hintStack=[],preserveHintStack,session;var POINTER_TOP_OFFSET=4,POSITION_BELOW_OFFSET=4;var handleCursorActivity;function setSession(value){session=value}function isHintDisplayed(){return hintState.visible===true}function positionHint(xpos,ypos,ybot){var hintWidth=$hintContainer.width(),hintHeight=$hintContainer.height(),top=ypos-hintHeight-POINTER_TOP_OFFSET,left=xpos,$editorHolder=$("#editor-holder"),editorLeft;if($editorHolder.offset()===undefined){return}editorLeft=$editorHolder.offset().left;left=Math.max(left,editorLeft);left=Math.min(left,editorLeft+$editorHolder.width()-hintWidth);if(top<0){$hintContainer.removeClass("preview-bubble-above");$hintContainer.addClass("preview-bubble-below");top=ybot+POSITION_BELOW_OFFSET;$hintContainer.offset({left:left,top:top})}else{$hintContainer.removeClass("preview-bubble-below");$hintContainer.addClass("preview-bubble-above");$hintContainer.offset({left:left,top:top-POINTER_TOP_OFFSET})}}function formatHint(functionInfo){var hints=session.getParameterHint(functionInfo.functionCallPos);$hintContent.empty();$hintContent.addClass("brackets-js-hints");function appendSeparators(separators){$hintContent.append(separators)}function appendParameter(param,index){if(hints.currentIndex===index){$hintContent.append($("<span>").append(_.escape(param)).addClass("current-parameter"))}else{$hintContent.append(_.escape(param))}}if(hints.parameters.length>0){HintsUtils2.formatParameterHint(hints.parameters,appendSeparators,appendParameter)}else{$hintContent.append(_.escape(Strings.NO_ARGUMENTS))}}function pushHintOnStack(){hintStack.push(hintState)}function popHintFromStack(){if(hintStack.length>0){hintState=hintStack.pop();hintState.visible=false;return true}return false}function clearFunctionHintStack(){hintStack=[]}function hasFunctionCallPosChanged(functionCallPos){var oldFunctionCallPos=hintState.functionCallPos;return oldFunctionCallPos===undefined||oldFunctionCallPos.line!==functionCallPos.line||oldFunctionCallPos.ch!==functionCallPos.ch}function dismissHint(){if(hintState.visible){$hintContainer.hide();$hintContent.empty();hintState={};session.editor.off("cursorActivity",handleCursorActivity);if(!preserveHintStack){clearFunctionHintStack()}}}function popUpHint(pushExistingHint,hint,functionInfo){functionInfo=functionInfo||session.getFunctionInfo();if(!functionInfo.inFunctionCall){dismissHint();return null}if(hasFunctionCallPosChanged(functionInfo.functionCallPos)){var pushHint=pushExistingHint&&isHintDisplayed();if(pushHint){pushHintOnStack();preserveHintStack=true}dismissHint();preserveHintStack=false}else if(isHintDisplayed()){return null}hintState.functionCallPos=functionInfo.functionCallPos;var request=null;var $deferredPopUp=$.Deferred();if(!hint){request=ScopeManager.requestParameterHint(session,functionInfo.functionCallPos)}else{session.setFnType(hint);request=$.Deferred();request.resolveWith(null,[hint]);$deferredPopUp.resolveWith(null)}request.done(function(fnType){var cm=session.editor._codeMirror,pos=cm.charCoords(functionInfo.functionCallPos);formatHint(functionInfo);$hintContainer.show();positionHint(pos.left,pos.top,pos.bottom);hintState.visible=true;hintState.fnType=fnType;session.editor.on("cursorActivity",handleCursorActivity);$deferredPopUp.resolveWith(null)}).fail(function(){hintState={}});return $deferredPopUp}function popUpHintAtOpenParen(){var functionInfo=session.getFunctionInfo();if(functionInfo.inFunctionCall){var token=session.getToken();if(token&&token.string==="("){return popUpHint()}}else{dismissHint()}return null}handleCursorActivity=function(){var functionInfo=session.getFunctionInfo();if(functionInfo.inFunctionCall){if(hasFunctionCallPosChanged(functionInfo.functionCallPos)){if(popHintFromStack()){var poppedFunctionCallPos=hintState.functionCallPos,currentFunctionCallPos=functionInfo.functionCallPos;if(poppedFunctionCallPos.line===currentFunctionCallPos.line&&poppedFunctionCallPos.ch===currentFunctionCallPos.ch){preserveHintStack=true;popUpHint(OVERWRITE_EXISTING_HINT,hintState.fnType,functionInfo);preserveHintStack=false;return}}else{dismissHint()}}formatHint(functionInfo);return}dismissHint()};function startCursorTracking(session){session.editor.on("cursorActivity",handleCursorActivity)}function stopCursorTracking(session){session.editor.off("cursorActivity",handleCursorActivity)}function handleShowParameterHint(){popUpHint()}function installListeners(editor){editor.on("keydown",function(event,editor,domEvent){if(domEvent.keyCode===KeyEvent.DOM_VK_ESCAPE){dismissHint()}}).on("scroll",function(){dismissHint()})}function addCommands(){CommandManager.register(Strings.CMD_SHOW_PARAMETER_HINT,SHOW_PARAMETER_HINT_CMD_ID,handleShowParameterHint);var menu=Menus.getMenu(Menus.AppMenuBar.EDIT_MENU);if(menu){menu.addMenuItem(SHOW_PARAMETER_HINT_CMD_ID,KeyboardPrefs.showParameterHint,Menus.AFTER,Commands.SHOW_CODE_HINTS)}CommandManager.on("beforeExecuteCommand",function(event,commandId){if(commandId!==SHOW_PARAMETER_HINT_CMD_ID&&commandId!==Commands.SHOW_CODE_HINTS){dismissHint()}})}$hintContainer=$(hintContainerHTML).appendTo($("body"));$hintContent=$hintContainer.find(".function-hint-content");exports.PUSH_EXISTING_HINT=PUSH_EXISTING_HINT;exports.addCommands=addCommands;exports.dismissHint=dismissHint;exports.installListeners=installListeners;exports.isHintDisplayed=isHintDisplayed;exports.popUpHint=popUpHint;exports.popUpHintAtOpenParen=popUpHintAtOpenParen;exports.setSession=setSession;exports.startCursorTracking=startCursorTracking;exports.stopCursorTracking=stopCursorTracking});