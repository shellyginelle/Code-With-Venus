define(function(require,exports,module){"use strict";var MultiRangeInlineEditor=brackets.getModule("editor/MultiRangeInlineEditor").MultiRangeInlineEditor,EditorManager=brackets.getModule("editor/EditorManager"),JSUtils=brackets.getModule("language/JSUtils"),LanguageManager=brackets.getModule("language/LanguageManager"),PerfUtils=brackets.getModule("utils/PerfUtils"),ProjectManager=brackets.getModule("project/ProjectManager"),Strings=brackets.getModule("strings");function _getFunctionName(hostEditor,pos){var token=hostEditor._codeMirror.getTokenAt(pos,true);if(!/\S/.test(token.string)||token.string==="."){token=hostEditor._codeMirror.getTokenAt({line:pos.line,ch:pos.ch+1},true)}if(!(token.type==="variable"||token.type==="variable-2"||token.type==="property")){return{functionName:null,reason:Strings.ERROR_JSQUICKEDIT_FUNCTIONNOTFOUND}}return{functionName:token.string,reason:null}}function _findInProject(functionName){var result=new $.Deferred;PerfUtils.markStart(PerfUtils.JAVASCRIPT_FIND_FUNCTION);function _nonBinaryFileFilter(file){return!LanguageManager.getLanguageForPath(file.fullPath).isBinary()}ProjectManager.getAllFiles(_nonBinaryFileFilter).done(function(files){JSUtils.findMatchingFunctions(functionName,files).done(function(functions){PerfUtils.addMeasurement(PerfUtils.JAVASCRIPT_FIND_FUNCTION);result.resolve(functions)}).fail(function(){PerfUtils.finalizeMeasurement(PerfUtils.JAVASCRIPT_FIND_FUNCTION);result.reject()})}).fail(function(){result.reject()});return result.promise()}function _createInlineEditor(hostEditor,functionName){var helper=brackets._jsCodeHintsHelper;if(helper===null){return null}var result=new $.Deferred;PerfUtils.markStart(PerfUtils.JAVASCRIPT_INLINE_CREATE);var response=helper();if(response.hasOwnProperty("promise")){response.promise.done(function(jumpResp){var resolvedPath=jumpResp.fullPath;if(resolvedPath){var fileInfos=[];fileInfos.push({name:jumpResp.resultFile,fullPath:resolvedPath});JSUtils.findMatchingFunctions(functionName,fileInfos,true).done(function(functions){if(functions&&functions.length>0){var jsInlineEditor=new MultiRangeInlineEditor(functions);jsInlineEditor.load(hostEditor);PerfUtils.addMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.resolve(jsInlineEditor)}else{PerfUtils.addMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.reject()}}).fail(function(){PerfUtils.addMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.reject()})}else{_findInProject(functionName).done(function(functions){if(functions&&functions.length>0){var jsInlineEditor=new MultiRangeInlineEditor(functions);jsInlineEditor.load(hostEditor);PerfUtils.addMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.resolve(jsInlineEditor)}else{PerfUtils.addMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.reject()}}).fail(function(){PerfUtils.finalizeMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.reject()})}}).fail(function(){PerfUtils.finalizeMeasurement(PerfUtils.JAVASCRIPT_INLINE_CREATE);result.reject()})}return result.promise()}function javaScriptFunctionProvider(hostEditor,pos){if(hostEditor.getModeForSelection()!=="javascript"){return null}var sel=hostEditor.getSelection();if(sel.start.line!==sel.end.line){return null}var functionResult=_getFunctionName(hostEditor,sel.start);if(!functionResult.functionName){return functionResult.reason||null}return _createInlineEditor(hostEditor,functionResult.functionName)}EditorManager.registerInlineEditProvider(javaScriptFunctionProvider);PerfUtils.createPerfMeasurement("JAVASCRIPT_INLINE_CREATE","JavaScript Inline Editor Creation");PerfUtils.createPerfMeasurement("JAVASCRIPT_FIND_FUNCTION","JavaScript Find Function");exports.javaScriptFunctionProvider=javaScriptFunctionProvider;exports._createInlineEditor=_createInlineEditor;exports._findInProject=_findInProject});