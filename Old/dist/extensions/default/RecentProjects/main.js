define(function(require,exports,module){"use strict";var ProjectManager=brackets.getModule("project/ProjectManager"),SidebarView=brackets.getModule("project/SidebarView"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),Commands=brackets.getModule("command/Commands"),CommandManager=brackets.getModule("command/CommandManager"),KeyBindingManager=brackets.getModule("command/KeyBindingManager"),Menus=brackets.getModule("command/Menus"),MainViewManager=brackets.getModule("view/MainViewManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),FileSystem=brackets.getModule("filesystem/FileSystem"),AppInit=brackets.getModule("utils/AppInit"),KeyEvent=brackets.getModule("utils/KeyEvent"),FileUtils=brackets.getModule("file/FileUtils"),PopUpManager=brackets.getModule("widgets/PopUpManager"),Strings=brackets.getModule("strings"),ProjectsMenuTemplate=require("text!htmlContent/projects-menu.html");var KeyboardPrefs=JSON.parse(require("text!keyboard.json"));var TOGGLE_DROPDOWN="recentProjects.toggle";var MAX_PROJECTS=20;var $dropdownItem,$dropdown,$links;function getRecentProjects(){var recentProjects=PreferencesManager.getViewState("recentProjects")||[],i;for(i=0;i<recentProjects.length;i++){recentProjects[i]=FileUtils.stripTrailingSlash(ProjectManager.updateWelcomeProjectPath(recentProjects[i]+"/"))}return recentProjects}function add(){var root=FileUtils.stripTrailingSlash(ProjectManager.getProjectRoot().fullPath),recentProjects=getRecentProjects(),index=recentProjects.indexOf(root);if(index!==-1){recentProjects.splice(index,1)}recentProjects.unshift(root);if(recentProjects.length>MAX_PROJECTS){recentProjects=recentProjects.slice(0,MAX_PROJECTS)}PreferencesManager.setViewState("recentProjects",recentProjects)}function checkHovers(pageX,pageY){$dropdown.children().each(function(){var offset=$(this).offset(),width=$(this).outerWidth(),height=$(this).outerHeight();if(pageX>=offset.left&&pageX<=offset.left+width&&pageY>=offset.top&&pageY<=offset.top+height){$(".recent-folder-link",this).triggerHandler("mouseenter")}})}function renderDelete(){return $("<div id='recent-folder-delete' class='trash-icon'>&times;</div>").mouseup(function(e){e.stopPropagation();var recentProjects=getRecentProjects(),index=recentProjects.indexOf($(this).parent().data("path")),newProjects=[],i;for(i=0;i<recentProjects.length;i++){if(i!==index){newProjects.push(recentProjects[i])}}PreferencesManager.setViewState("recentProjects",newProjects);$(this).closest("li").remove();checkHovers(e.pageX,e.pageY);if(newProjects.length===1){$dropdown.find(".divider").remove()}})}function removeDeleteButton(){$("#recent-folder-delete").remove()}function addDeleteButton($target){removeDeleteButton();renderDelete().css("top",$target.position().top+6).appendTo($target)}function selectNextItem(direction){var $links=$dropdown.find("a"),index=$dropdownItem?$links.index($dropdownItem):direction>0?-1:0,$newItem=$links.eq((index+direction)%$links.length);if($dropdownItem){$dropdownItem.removeClass("selected")}$newItem.addClass("selected");$dropdownItem=$newItem;removeDeleteButton()}function removeSelectedItem(e){var recentProjects=getRecentProjects(),$cacheItem=$dropdownItem,index=recentProjects.indexOf($cacheItem.data("path"));if(index===-1){return false}recentProjects.splice(index,1);PreferencesManager.setViewState("recentProjects",recentProjects);checkHovers(e.pageX,e.pageY);if(recentProjects.length===1){$dropdown.find(".divider").remove()}selectNextItem(+1);$cacheItem.closest("li").remove();return true}function keydownHook(event){var keyHandled=false;switch(event.keyCode){case KeyEvent.DOM_VK_UP:selectNextItem(-1);keyHandled=true;break;case KeyEvent.DOM_VK_DOWN:selectNextItem(+1);keyHandled=true;break;case KeyEvent.DOM_VK_ENTER:case KeyEvent.DOM_VK_RETURN:if($dropdownItem){$dropdownItem.trigger("click")}keyHandled=true;break;case KeyEvent.DOM_VK_BACK_SPACE:case KeyEvent.DOM_VK_DELETE:if($dropdownItem){removeSelectedItem(event);keyHandled=true}break}if(keyHandled){event.stopImmediatePropagation();event.preventDefault()}return keyHandled}function closeDropdown(){if($dropdown){PopUpManager.removePopUp($dropdown)}}function cleanupDropdown(){$("html").off("click",closeDropdown);$("#project-files-container").off("scroll",closeDropdown);$("#titlebar .nav").off("click",closeDropdown);$dropdown=null;MainViewManager.focusActivePane();$(window).off("keydown",keydownHook)}function _handleListEvents(){$dropdown.on("click","a",function(){var $link=$(this),id=$link.attr("id"),path=$link.data("path");if(path){ProjectManager.openProject(path).fail(function(){var recentProjects=getRecentProjects(),index=recentProjects.indexOf(path);if(index!==-1){FileSystem.resolve(path,function(err,item){if(err){recentProjects.splice(index,1)}})}});closeDropdown()}else if(id==="open-folder-link"){CommandManager.execute(Commands.FILE_OPEN_FOLDER)}}).on("mouseenter","a",function(){if($dropdownItem){$dropdownItem.removeClass("selected")}$dropdownItem=$(this).addClass("selected");if($dropdownItem.hasClass("recent-folder-link")){addDeleteButton($(this))}}).on("mouseleave","a",function(){var $link=$(this).removeClass("selected");if($link.get(0)===$dropdownItem.get(0)){$dropdownItem=null}if($link.hasClass("recent-folder-link")){removeDeleteButton()}})}function parsePath(path){var lastSlash=path.lastIndexOf("/"),folder,rest;if(lastSlash===path.length-1){lastSlash=path.slice(0,path.length-1).lastIndexOf("/")}if(lastSlash>=0){rest=" - "+(lastSlash?path.slice(0,lastSlash):"/");folder=path.slice(lastSlash+1)}else{rest="/";folder=path}return{path:path,folder:folder,rest:rest}}function renderList(){var recentProjects=getRecentProjects(),currentProject=FileUtils.stripTrailingSlash(ProjectManager.getProjectRoot().fullPath),templateVars={projectList:[],Strings:Strings};recentProjects.forEach(function(root){if(root!==currentProject){templateVars.projectList.push(parsePath(root))}});return Mustache.render(ProjectsMenuTemplate,templateVars)}function showDropdown(position){if($dropdown){return}Menus.closeAll();$dropdown=$(renderList()).css({left:position.pageX,top:position.pageY}).appendTo($("body"));PopUpManager.addPopUp($dropdown,cleanupDropdown,true);$("html").on("click",closeDropdown);$("#project-files-container").on("scroll",closeDropdown);$("#titlebar .nav").on("click",closeDropdown);_handleListEvents();$(window).on("keydown",keydownHook)}function handleKeyEvent(){if(!$dropdown){if(!SidebarView.isVisible()){SidebarView.show()}$("#project-dropdown-toggle").trigger("click");$dropdown.focus();$links=$dropdown.find("a");$dropdownItem=$links.eq($links.length>1?1:0);$dropdownItem.addClass("selected");window.setTimeout(function(){$dropdown.focus()},0)}}PreferencesManager.convertPreferences(module,{recentProjects:"user"},true);CommandManager.register(Strings.CMD_TOGGLE_RECENT_PROJECTS,TOGGLE_DROPDOWN,handleKeyEvent);KeyBindingManager.addBinding(TOGGLE_DROPDOWN,KeyboardPrefs.recentProjects);AppInit.appReady(function(){ExtensionUtils.loadStyleSheet(module,"styles/styles.less");ProjectManager.on("projectOpen",add);ProjectManager.on("beforeProjectClose",add)});AppInit.htmlReady(function(){$("#project-title").wrap("<div id='project-dropdown-toggle' class='btn-alt-quiet'></div>").after("<span class='dropdown-arrow'></span>");var cmenuAdapter={open:showDropdown,close:closeDropdown,isOpen:function(){return!!$dropdown}};Menus.ContextMenu.assignContextMenuToSelector("#project-dropdown-toggle",cmenuAdapter)})});