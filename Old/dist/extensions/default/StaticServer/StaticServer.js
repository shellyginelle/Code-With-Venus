define(function(require,exports,module){"use strict";var BaseServer=brackets.getModule("LiveDevelopment/Servers/BaseServer").BaseServer,LiveDevelopmentUtils=brackets.getModule("LiveDevelopment/LiveDevelopmentUtils"),PreferencesManager=brackets.getModule("preferences/PreferencesManager");var _prefs=PreferencesManager.getExtensionPrefs("staticserver");function StaticServer(config){this._nodeDomain=config.nodeDomain;this._onRequestFilter=this._onRequestFilter.bind(this);BaseServer.call(this,config)}StaticServer.prototype=Object.create(BaseServer.prototype);StaticServer.prototype.constructor=StaticServer;StaticServer.prototype.canServe=function(localPath){if(!this._nodeDomain.ready()){return false}if(localPath===this._pathResolver(localPath)){return false}if(localPath.match(/\/$/)){return true}return LiveDevelopmentUtils.isStaticHtmlFileExt(localPath)};StaticServer.prototype._updateRequestFilterPaths=function(){var paths=Object.keys(this._liveDocuments);return this._nodeDomain.exec("setRequestFilterPaths",this._root,paths)};StaticServer.prototype.readyToServe=function(){var self=this;var deferred=new $.Deferred;function sanitizePort(port){port=parseInt(port,10);port=port&&!isNaN(port)&&port>0&&port<65536?port:0;return port}function onSuccess(address){self._baseUrl="http://"+address.address+":"+address.port+"/";deferred.resolve()}function onFailure(){self._baseUrl="";deferred.resolve()}var port=sanitizePort(_prefs.get("port"));this._nodeDomain.exec("getServer",self._root,port).done(function(address){if(address.port!==port&&port>0){return self._nodeDomain.exec("closeServer",self._root).done(function(){return self._nodeDomain.exec("getServer",self._root,port).done(onSuccess).fail(onFailure)}).fail(onFailure)}onSuccess(address)}).fail(onFailure);return deferred.promise()};StaticServer.prototype.add=function(liveDocument){if(liveDocument.setInstrumentationEnabled){liveDocument.setInstrumentationEnabled(true)}BaseServer.prototype.add.call(this,liveDocument);this._updateRequestFilterPaths()};StaticServer.prototype.remove=function(liveDocument){BaseServer.prototype.remove.call(this,liveDocument);this._updateRequestFilterPaths()};StaticServer.prototype.clear=function(){BaseServer.prototype.clear.call(this);this._updateRequestFilterPaths()};StaticServer.prototype._send=function(location,response){this._nodeDomain.exec("writeFilteredResponse",location.root,location.pathname,response)};StaticServer.prototype._onRequestFilter=function(event,request){var key=request.location.pathname,liveDocument=this._liveDocuments[key],response;if(liveDocument&&liveDocument.getResponseData){response=liveDocument.getResponseData()}else{response={}}response.id=request.id;this._send(request.location,response)};StaticServer.prototype.start=function(){this._nodeDomain.on("requestFilter",this._onRequestFilter)};StaticServer.prototype.stop=function(){this._nodeDomain.off("requestFilter",this._onRequestFilter)};module.exports=StaticServer});