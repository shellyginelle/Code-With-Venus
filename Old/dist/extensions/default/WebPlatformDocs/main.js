define(function(require,exports,module){"use strict";var _=brackets.getModule("thirdparty/lodash"),EditorManager=brackets.getModule("editor/EditorManager"),CSSUtils=brackets.getModule("language/CSSUtils"),HTMLUtils=brackets.getModule("language/HTMLUtils"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils");var InlineDocsViewer=require("InlineDocsViewer");var promiseCache={};function getDocs(fileName){if(!promiseCache[fileName]){var result=new $.Deferred;$.ajax({url:ExtensionUtils.getModulePath(module,fileName),dataType:"json"}).done(function(data,status,jqXHR){result.resolve(data)}).fail(function(jqXHR,status,err){console.error("Unable to load documentation database: ",err);result.reject()});promiseCache[fileName]=result.promise()}return promiseCache[fileName]}function inlineProvider(hostEditor,pos){var jsonFile,propInfo,propQueue=[],langId=hostEditor.getLanguageForSelection().getId(),supportedLangs=["css","scss","less","html"],langIndex=langId?supportedLangs.indexOf(langId):-1;if(langIndex<0){return null}var sel=hostEditor.getSelection();if(sel.start.line!==sel.end.line){return null}if(langIndex<=2){jsonFile="css.json";propInfo=CSSUtils.getInfoAtPos(hostEditor,sel.start);if(propInfo.name){propQueue.push("css/properties/"+propInfo.name);propQueue.push("css/properties/"+propInfo.name.replace(/^-(?:webkit|moz|ms|o)-/,""))}}else{jsonFile="html.json";propInfo=HTMLUtils.getTagInfo(hostEditor,sel.start);if(propInfo.position.tokenType===HTMLUtils.ATTR_NAME&&propInfo.attr&&propInfo.attr.name){propQueue.push("html/attributes/"+propInfo.attr.name.toLowerCase())}if(propInfo.tagName){propInfo=propInfo.tagName.toLowerCase();if(/^h[1-6]$/.test(propInfo)){propInfo="hn"}propQueue.push("html/elements/"+propInfo)}}if(propQueue.length){var result=new $.Deferred;getDocs(jsonFile).done(function(docs){docs=docs.PROPERTIES;var displayName,propDetails,propName=_.find(propQueue,function(propName){return docs.hasOwnProperty(propName)});if(propName){var propPrefix=propName.substr(0,propName.lastIndexOf("/"));propDetails=docs[propName];displayName=propName.substr(propName.lastIndexOf("/")+1);if(propPrefix==="html/elements"){displayName="<"+displayName+">"}}if(propDetails){var inlineWidget=new InlineDocsViewer(displayName,propDetails);inlineWidget.load(hostEditor);result.resolve(inlineWidget)}else{result.reject()}}).fail(function(){result.reject()});return result.promise()}else{return null}}EditorManager.registerInlineDocsProvider(inlineProvider);exports._getDocs=getDocs;exports._inlineProvider=inlineProvider});