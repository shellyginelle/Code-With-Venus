define(function(require,exports,module){"use strict";var Menus=brackets.getModule("command/Menus"),Resizer=brackets.getModule("utils/Resizer"),UrlParams=brackets.getModule("utils/UrlParams").UrlParams,StatusBar=brackets.getModule("widgets/StatusBar"),Strings=brackets.getModule("strings"),MainViewManager=brackets.getModule("view/MainViewManager"),BrambleEvents=brackets.getModule("bramble/BrambleEvents"),BrambleStartupState=brackets.getModule("bramble/StartupState"),FileSystem=brackets.getModule("filesystem/FileSystem"),ViewCommandHandlers=brackets.getModule("view/ViewCommandHandlers"),SidebarView=brackets.getModule("project/SidebarView"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),PreferencesManager=brackets.getModule("preferences/PreferencesManager");var PhonePreview=require("text!lib/Mobile.html");var PostMessageTransport=require("lib/PostMessageTransport");var IframeBrowser=require("lib/iframe-browser");var Compatibility=require("lib/compatibility");var Theme=require("lib/Theme");var isMobileViewOpen=false;function initUI(callback){addLivePreviewButton(function(){toggleMobileViewButton();var root=BrambleStartupState.project("root");FileSystem.getDirectoryForPath(root).getContents(function(err,contents){if(shouldHideUI()){removeTitleBar();removeMainToolBar();removeLeftSideToolBar();removeRightSideToolBar();removeStatusBar();if(contents&&contents.length===1){SidebarView.hide()}}restoreState();$("#spinner-container").remove();$("#main-view").css("visibility","visible");callback()})})}function restoreState(){Theme.init(BrambleStartupState.ui("theme"));var previewMode=BrambleStartupState.ui("previewMode");if(previewMode){switch(previewMode){case"desktop":showDesktopView(true);break;case"mobile":showMobileView(true);break;default:console.warn("[Bramble] unknown preview mode: `"+previewMode+"`")}}var wordWrap=BrambleStartupState.ui("wordWrap");if(typeof wordWrap==="boolean"){PreferencesManager.set("wordWrap",wordWrap)}var sidebarWidth=BrambleStartupState.ui("sidebarWidth");if(sidebarWidth){SidebarView.resize(sidebarWidth)}var sidebarVisible=BrambleStartupState.ui("sidebarVisible");if(sidebarVisible!==null){if(sidebarVisible){SidebarView.show()}else{SidebarView.hide()}}var firstPaneWidth=BrambleStartupState.ui("firstPaneWidth");if(firstPaneWidth){$("#first-pane").width(firstPaneWidth)}var fontSize=BrambleStartupState.ui("fontSize");if(fontSize&&/\d+px/.test(fontSize)){ViewCommandHandlers.setFontSize(fontSize)}WorkspaceManager.recomputeLayout(true)}function shouldHideUI(){var params=new UrlParams;params.parse();return params.get("ui")!=="1"}function removeStatusBar(){StatusBar.disable()}function removeLeftSideToolBar(){$("#working-set-list-second-pane").addClass("hideLeftToolbar");$("#sidebar .working-set-splitview-btn").remove()}function removeTitleBar(){$("#titlebar").remove();$("#first-pane .pane-header").remove();$("#editor-holder").addClass("editor-holder-height");$("#first-pane .pane-content, .cm-s-light-theme").addClass("first-pane-height")}function removeMainToolBar(){Menus.removeMenu(Menus.AppMenuBar.FILE_MENU);Menus.removeMenu(Menus.AppMenuBar.EDIT_MENU);Menus.removeMenu(Menus.AppMenuBar.FIND_MENU);Menus.removeMenu(Menus.AppMenuBar.VIEW_MENU);Menus.removeMenu(Menus.AppMenuBar.NAVIGATE_MENU);Menus.removeMenu(Menus.AppMenuBar.HELP_MENU)}function removeRightSideToolBar(){Resizer.makeResizable("#main-toolbar");Resizer.hide("#main-toolbar");$(".content").addClass("hideRightToolbar")}function stealFocus(e){e.preventDefault();MainViewManager.setActivePaneId("first-pane")}function enableFullscreenPreview(){$("#main-view").addClass("fullscreen-preview")}function disableFullscreenPreview(){$("#main-view").removeClass("fullscreen-preview");MainViewManager.setActivePaneId("first-pane")}function showDesktopView(preventReload){if(!isMobileViewOpen){return}$("#mobileViewButton").removeClass("desktopButton");$("#mobileViewButton").addClass("mobileButton");StatusBar.updateIndicator("mobileViewButtonBox",true,"","Click to open preview in a mobile view");$("#bramble-iframe-browser").appendTo("#second-pane");$(".phone-wrapper").detach();$("#second-pane").removeClass("second-pane-scroll");$("#second-pane").off("click",stealFocus);isMobileViewOpen=false;BrambleEvents.triggerPreviewModeChange("desktop");if(!preventReload){PostMessageTransport.reload()}}function showMobileView(preventReload){if(isMobileViewOpen){return}$("#mobileViewButton").removeClass("mobileButton");$("#mobileViewButton").addClass("desktopButton");StatusBar.updateIndicator("mobileViewButtonBox",true,"","Click to open preview in a desktop view");$("#bramble-iframe-browser").addClass("phone-body");$("#second-pane").append(PhonePreview);$("#bramble-iframe-browser").appendTo("#phone-content");$("#second-pane").addClass("second-pane-scroll");$("#second-pane").on("click",stealFocus);isMobileViewOpen=true;BrambleEvents.triggerPreviewModeChange("mobile");if(!preventReload){PostMessageTransport.reload()}}function toggleMobileViewButton(){var mobileView=Mustache.render("<div><a id='mobileViewButton' href=#></a></div>",Strings);StatusBar.addIndicator("mobileViewButtonBox",$(mobileView),true,"","Click to open preview in a mobile view","status-overwrite");$("#mobileViewButton").addClass("mobileButton");$("#mobileViewButton").click(function(){if(!isMobileViewOpen){showMobileView()}else{showDesktopView()}})}function addLivePreviewButton(callback){var livePreview=Mustache.render("<div><a id='liveDevButton' href=#></a></div>",Strings);StatusBar.addIndicator("liveDevButtonBox",$(livePreview),true,"","Click to open preview in separate window","mobileViewButtonBox");$("#liveDevButton").addClass("liveDevButtonDetach");$("#liveDevButton").click(function(){Resizer.makeResizable("#second-pane");if(Resizer.isVisible("#second-pane")){IframeBrowser.detachPreview()}else{IframeBrowser.attachPreview()}});Compatibility.supportsIFrameHTMLBlobURL(function(err,isCompatible){if(err){console.error("[Brackets IFrame-Browser] Unexpected error:",err);return callback()}if(!isCompatible&&document.all){$("#liveDevButton").css("display","none");console.log("[Brackets IFrame-Browser] Detachable preview disabled due to incompatibility with current browser (you are possibly running IE 10 or below)")}callback()})}function getPreviewMode(){return isMobileViewOpen?"mobile":"desktop"}exports.initUI=initUI;exports.showMobileView=showMobileView;exports.showDesktopView=showDesktopView;exports.enableFullscreenPreview=enableFullscreenPreview;exports.disableFullscreenPreview=disableFullscreenPreview;exports.getPreviewMode=getPreviewMode;exports.removeLeftSideToolBar=removeLeftSideToolBar;exports.removeMainToolBar=removeMainToolBar;exports.removeRightSideToolBar=removeRightSideToolBar});