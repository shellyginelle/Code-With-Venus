define(function(require,exports,module){"use strict";var SAVE_DELAY_MS=5*1e3;var SAVE_ON_EDITOR_CHANGE=true;var FILE_SAVE=brackets.getModule("command/Commands").FILE_SAVE,SaveCommand=brackets.getModule("command/CommandManager").get(FILE_SAVE),DocumentManager=brackets.getModule("document/DocumentManager"),EditorManager=brackets.getModule("editor/EditorManager");var pending={};function scheduleSave(doc,immediate){var path=doc.file.fullPath;if(pending[path]&&!immediate){return}doc.addRef();function finish(){doc.releaseRef();clearTimeout(pending[path]);delete pending[path]}function doSave(){if(!doc.isDirty){finish();return}SaveCommand.execute({doc:doc}).done(finish).fail(function(err){console.error("[Autosave] failed write for `"+path+"`",err);finish()})}if(immediate){doSave()}else{pending[path]=setTimeout(doSave,SAVE_DELAY_MS)}}DocumentManager.on("dirtyFlagChange",function(evt,doc){if(doc.isDirty){scheduleSave(doc)}});EditorManager.on("activeEditorChange",function(evt,current,previous){if(previous&&previous.document.isDirty&&SAVE_ON_EDITOR_CHANGE){scheduleSave(previous.document,true)}})});