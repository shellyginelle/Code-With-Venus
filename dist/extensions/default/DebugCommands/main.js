define(function(require,exports,module){"use strict";var _=brackets.getModule("thirdparty/lodash");var Commands=brackets.getModule("command/Commands"),CommandManager=brackets.getModule("command/CommandManager"),Menus=brackets.getModule("command/Menus"),FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),PerfUtils=brackets.getModule("utils/PerfUtils"),StringUtils=brackets.getModule("utils/StringUtils"),Dialogs=brackets.getModule("widgets/Dialogs"),Strings=brackets.getModule("strings"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),LocalizationUtils=brackets.getModule("utils/LocalizationUtils"),ErrorNotification=require("ErrorNotification"),NodeDebugUtils=require("NodeDebugUtils"),PerfDialogTemplate=require("text!htmlContent/perf-dialog.html"),LanguageDialogTemplate=require("text!htmlContent/language-dialog.html");var KeyboardPrefs=JSON.parse(require("text!keyboard.json"));var DEBUG_MENU="debug-menu";var DEBUG_REFRESH_WINDOW="debug.refreshWindow",DEBUG_SHOW_DEVELOPER_TOOLS="debug.showDeveloperTools",DEBUG_RUN_UNIT_TESTS="debug.runUnitTests",DEBUG_SHOW_PERF_DATA="debug.showPerfData",DEBUG_RELOAD_WITHOUT_USER_EXTS="debug.reloadWithoutUserExts",DEBUG_NEW_BRACKETS_WINDOW="debug.newBracketsWindow",DEBUG_SWITCH_LANGUAGE="debug.switchLanguage",DEBUG_ENABLE_NODE_DEBUGGER="debug.enableNodeDebugger",DEBUG_LOG_NODE_STATE="debug.logNodeState",DEBUG_RESTART_NODE="debug.restartNode",DEBUG_SHOW_ERRORS_IN_STATUS_BAR="debug.showErrorsInStatusBar",DEBUG_OPEN_BRACKETS_SOURCE="debug.openBracketsSource";PreferencesManager.definePreference(DEBUG_SHOW_ERRORS_IN_STATUS_BAR,"boolean",false);function handleShowDeveloperTools(){brackets.app.showDeveloperTools()}var _testWindow=null;function _runUnitTests(spec){var queryString=spec?"?spec="+spec:"";if(_testWindow&&!_testWindow.closed){if(_testWindow.location.search!==queryString){_testWindow.location.href="../test/SpecRunner.html"+queryString}else{_testWindow.location.reload(true)}}else{_testWindow=window.open("../test/SpecRunner.html"+queryString,"brackets-test","width="+$(window).width()+",height="+$(window).height());_testWindow.location.reload(true)}}function handleReload(){CommandManager.execute(Commands.APP_RELOAD)}function handleReloadWithoutUserExts(){CommandManager.execute(Commands.APP_RELOAD_WITHOUT_EXTS)}function handleNewBracketsWindow(){window.open(window.location.href)}function handleShowPerfData(){var templateVars={delimitedPerfData:PerfUtils.getDelimitedPerfData(),perfData:[]};var getValue=function(entry){if(Array.isArray(entry)){var i,e,avg,sum=0,min=Number.MAX_VALUE,max=0;for(i=0;i<entry.length;i++){e=entry[i];min=Math.min(min,e);sum+=e;max=Math.max(max,e)}avg=Math.round(sum*10/entry.length)/10;return String(min)+"/"+String(avg)+"("+entry.length+")/"+String(max)+"/"+String(e)}else{return entry}};var perfData=PerfUtils.getData();_.forEach(perfData,function(value,testName){templateVars.perfData.push({testName:StringUtils.breakableUrl(testName),value:getValue(value)})});var template=Mustache.render(PerfDialogTemplate,templateVars);Dialogs.showModalDialogUsingTemplate(template);$("#brackets-perf-raw-data").click(function(){$(this).focus().select()})}function handleSwitchLanguage(){var stringsPath=FileUtils.getNativeBracketsDirectoryPath()+"/nls";FileSystem.getDirectoryForPath(stringsPath).getContents(function(err,entries){if(!err){var $dialog,$submit,$select,locale,curLocale=brackets.isLocaleDefault()?null:brackets.getLocale(),languages=[];var setLanguage=function(event){locale=$select.val();$submit.prop("disabled",locale===(curLocale||""))};entries.forEach(function(entry){if(entry.isDirectory){var match=entry.name.match(/^([a-z]{2})(-[a-z]{2})?$/);if(match){var language=entry.name,label=match[1];if(match[2]){label+=match[2].toUpperCase()}languages.push({label:LocalizationUtils.getLocalizedLabel(label),language:language})}}});languages.push({label:LocalizationUtils.getLocalizedLabel("en"),language:"en"});languages.sort(function(lang1,lang2){return lang1.label.localeCompare(lang2.label)});languages.unshift({label:Strings.LANGUAGE_SYSTEM_DEFAULT,language:null});var template=Mustache.render(LanguageDialogTemplate,{languages:languages,Strings:Strings});Dialogs.showModalDialogUsingTemplate(template).done(function(id){if(id===Dialogs.DIALOG_BTN_OK&&locale!==curLocale){brackets.setLocale(locale);CommandManager.execute(Commands.APP_RELOAD)}});$dialog=$(".switch-language.instance");$submit=$dialog.find(".dialog-button[data-button-id='"+Dialogs.DIALOG_BTN_OK+"']");$select=$dialog.find("select");$select.on("change",setLanguage).val(curLocale)}})}function enableRunTestsMenuItem(){if(brackets.inBrowser){return}var file=FileSystem.getFileForPath(FileUtils.getNativeBracketsDirectoryPath()+"/../test/SpecRunner.html");file.exists(function(err,exists){if(!err&&exists){CommandManager.get(DEBUG_RUN_UNIT_TESTS).setEnabled(true)}})}function toggleErrorNotification(bool){var val,oldPref=!!PreferencesManager.get(DEBUG_SHOW_ERRORS_IN_STATUS_BAR);if(bool===undefined){val=!oldPref}else{val=!!bool}ErrorNotification.toggle(val);CommandManager.get(DEBUG_SHOW_ERRORS_IN_STATUS_BAR).setChecked(val);if(val!==oldPref){PreferencesManager.set(DEBUG_SHOW_ERRORS_IN_STATUS_BAR,val)}}function handleOpenBracketsSource(){var dir=FileUtils.getNativeBracketsDirectoryPath().replace(/\/[^\/]+$/,"/");brackets.app.showOSFolder(dir)}CommandManager.register(Strings.CMD_SHOW_DEV_TOOLS,DEBUG_SHOW_DEVELOPER_TOOLS,handleShowDeveloperTools).setEnabled(!!brackets.app.showDeveloperTools);CommandManager.register(Strings.CMD_REFRESH_WINDOW,DEBUG_REFRESH_WINDOW,handleReload);CommandManager.register(Strings.CMD_RELOAD_WITHOUT_USER_EXTS,DEBUG_RELOAD_WITHOUT_USER_EXTS,handleReloadWithoutUserExts);CommandManager.register(Strings.CMD_NEW_BRACKETS_WINDOW,DEBUG_NEW_BRACKETS_WINDOW,handleNewBracketsWindow);CommandManager.register(Strings.CMD_RUN_UNIT_TESTS,DEBUG_RUN_UNIT_TESTS,_runUnitTests).setEnabled(false);CommandManager.register(Strings.CMD_SHOW_PERF_DATA,DEBUG_SHOW_PERF_DATA,handleShowPerfData);CommandManager.register(Strings.CMD_OPEN_BRACKETS_SOURCE,DEBUG_OPEN_BRACKETS_SOURCE,handleOpenBracketsSource).setEnabled(!StringUtils.endsWith(decodeURI(window.location.pathname),"/www/index.html"));CommandManager.register(Strings.CMD_SWITCH_LANGUAGE,DEBUG_SWITCH_LANGUAGE,handleSwitchLanguage);CommandManager.register(Strings.CMD_SHOW_ERRORS_IN_STATUS_BAR,DEBUG_SHOW_ERRORS_IN_STATUS_BAR,toggleErrorNotification);CommandManager.register(Strings.CMD_ENABLE_NODE_DEBUGGER,DEBUG_ENABLE_NODE_DEBUGGER,NodeDebugUtils.enableDebugger);CommandManager.register(Strings.CMD_LOG_NODE_STATE,DEBUG_LOG_NODE_STATE,NodeDebugUtils.logNodeState);CommandManager.register(Strings.CMD_RESTART_NODE,DEBUG_RESTART_NODE,NodeDebugUtils.restartNode);enableRunTestsMenuItem();toggleErrorNotification(PreferencesManager.get(DEBUG_SHOW_ERRORS_IN_STATUS_BAR));PreferencesManager.on("change",DEBUG_SHOW_ERRORS_IN_STATUS_BAR,function(){toggleErrorNotification(PreferencesManager.get(DEBUG_SHOW_ERRORS_IN_STATUS_BAR))});var menu=Menus.addMenu(Strings.DEBUG_MENU,DEBUG_MENU,Menus.BEFORE,Menus.AppMenuBar.HELP_MENU);menu.addMenuItem(DEBUG_SHOW_DEVELOPER_TOOLS,KeyboardPrefs.showDeveloperTools);menu.addMenuItem(DEBUG_REFRESH_WINDOW,KeyboardPrefs.refreshWindow);menu.addMenuItem(DEBUG_RELOAD_WITHOUT_USER_EXTS,KeyboardPrefs.reloadWithoutUserExts);menu.addMenuItem(DEBUG_NEW_BRACKETS_WINDOW);menu.addMenuDivider();menu.addMenuItem(DEBUG_SWITCH_LANGUAGE);menu.addMenuDivider();menu.addMenuItem(DEBUG_RUN_UNIT_TESTS);menu.addMenuItem(DEBUG_SHOW_PERF_DATA);menu.addMenuItem(DEBUG_OPEN_BRACKETS_SOURCE);menu.addMenuDivider();menu.addMenuItem(DEBUG_ENABLE_NODE_DEBUGGER);menu.addMenuItem(DEBUG_LOG_NODE_STATE);menu.addMenuItem(DEBUG_RESTART_NODE);menu.addMenuItem(DEBUG_SHOW_ERRORS_IN_STATUS_BAR);menu.addMenuItem(Commands.FILE_OPEN_PREFERENCES);menu.addMenuItem(Commands.FILE_OPEN_KEYMAP);exports._runUnitTests=_runUnitTests});