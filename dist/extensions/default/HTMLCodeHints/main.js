define(function(require,exports,module){"use strict";var AppInit=brackets.getModule("utils/AppInit"),CodeHintManager=brackets.getModule("editor/CodeHintManager"),HTMLUtils=brackets.getModule("language/HTMLUtils"),HTMLTags=require("text!HtmlTags.json"),HTMLAttributes=require("text!HtmlAttributes.json"),tags,attributes;function TagHints(){this.exclusion=null}TagHints.prototype.updateExclusion=function(){var textAfterCursor;if(this.exclusion&&this.tagInfo){textAfterCursor=this.tagInfo.tagName.substr(this.tagInfo.position.offset);if(!CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){this.exclusion=null}}};TagHints.prototype.hasHints=function(editor,implicitChar){var pos=editor.getCursorPos();this.tagInfo=HTMLUtils.getTagInfo(editor,pos);this.editor=editor;if(implicitChar===null){if(this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME){if(this.tagInfo.position.offset>=0){if(this.tagInfo.position.offset===0){this.exclusion=this.tagInfo.tagName}else{this.updateExclusion()}return true}}return false}else{if(implicitChar==="<"){this.exclusion=this.tagInfo.tagName;return true}return false}};TagHints.prototype.getHints=function(implicitChar){var query,result;this.tagInfo=HTMLUtils.getTagInfo(this.editor,this.editor.getCursorPos());if(this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME){if(this.tagInfo.position.offset>=0){this.updateExclusion();query=this.tagInfo.tagName.slice(0,this.tagInfo.position.offset);result=$.map(tags,function(value,key){if(key.indexOf(query)===0){return key}}).sort();return{hints:result,match:query,selectInitial:true,handleWideResults:false}}}return null};TagHints.prototype.insertHint=function(completion){var start={line:-1,ch:-1},end={line:-1,ch:-1},cursor=this.editor.getCursorPos(),charCount=0;if(this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME){var textAfterCursor=this.tagInfo.tagName.substr(this.tagInfo.position.offset);if(CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){charCount=this.tagInfo.position.offset}else{charCount=this.tagInfo.tagName.length}}end.line=start.line=cursor.line;start.ch=cursor.ch-this.tagInfo.position.offset;end.ch=start.ch+charCount;if(this.exclusion||completion!==this.tagInfo.tagName){if(start.ch!==end.ch){this.editor.document.replaceRange(completion,start,end)}else{this.editor.document.replaceRange(completion,start)}this.exclusion=null}return false};function AttrHints(){this.globalAttributes=this.readGlobalAttrHints();this.cachedHints=null;this.exclusion=""}AttrHints.prototype.readGlobalAttrHints=function(){return $.map(attributes,function(value,key){if(value.global==="true"){return key}})};AttrHints.prototype._getValueHintsForAttr=function(query,tagName,attrName){var hints=[];var tagPlusAttr=tagName+"/"+attrName,attrInfo=attributes[tagPlusAttr]||attributes[attrName];if(attrInfo){if(attrInfo.type==="boolean"){hints=["false","true"]}else if(attrInfo.attribOption){hints=attrInfo.attribOption}}return hints};AttrHints.prototype.updateExclusion=function(attrNameOnly){if(this.exclusion&&this.tagInfo){var tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,textAfterCursor;if(tokenType===HTMLUtils.ATTR_NAME){textAfterCursor=this.tagInfo.attr.name.substr(offset)}else if(!attrNameOnly&&tokenType===HTMLUtils.ATTR_VALUE){textAfterCursor=this.tagInfo.attr.value.substr(offset)}if(!CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){this.exclusion=null}}};AttrHints.prototype.hasHints=function(editor,implicitChar){var pos=editor.getCursorPos(),tokenType,offset,query;this.editor=editor;this.tagInfo=HTMLUtils.getTagInfo(editor,pos);tokenType=this.tagInfo.position.tokenType;offset=this.tagInfo.position.offset;if(implicitChar===null){query=null;if(tokenType===HTMLUtils.ATTR_NAME){if(offset>=0){query=this.tagInfo.attr.name.slice(0,offset)}}else if(tokenType===HTMLUtils.ATTR_VALUE){if(this.tagInfo.position.offset>=0){query=this.tagInfo.attr.value.slice(0,offset)}else{query=""}if(this.tagInfo.attr.name){var hints=this._getValueHintsForAttr({queryStr:query},this.tagInfo.tagName,this.tagInfo.attr.name);if(hints instanceof Array){var i,foundPrefix=false;for(i=0;i<hints.length;i++){if(hints[i].indexOf(query)===0){foundPrefix=true;break}}if(!foundPrefix){query=null}}}}if(offset>=0){if(tokenType===HTMLUtils.ATTR_NAME&&offset===0){this.exclusion=this.tagInfo.attr.name}else{this.updateExclusion(false)}}return query!==null}else{if(implicitChar===" "||implicitChar==="'"||implicitChar==='"'||implicitChar==="="){if(tokenType===HTMLUtils.ATTR_NAME){this.exclusion=this.tagInfo.attr.name}return true}return false}};AttrHints.prototype.getHints=function(implicitChar){var cursor=this.editor.getCursorPos(),query={queryStr:null},tokenType,offset,result=[];this.tagInfo=HTMLUtils.getTagInfo(this.editor,cursor);tokenType=this.tagInfo.position.tokenType;offset=this.tagInfo.position.offset;if(tokenType===HTMLUtils.ATTR_NAME||tokenType===HTMLUtils.ATTR_VALUE){query.tag=this.tagInfo.tagName;if(offset>=0){if(tokenType===HTMLUtils.ATTR_NAME){query.queryStr=this.tagInfo.attr.name.slice(0,offset)}else{query.queryStr=this.tagInfo.attr.value.slice(0,offset);query.attrName=this.tagInfo.attr.name}this.updateExclusion(false)}else if(tokenType===HTMLUtils.ATTR_VALUE){query.queryStr="";query.attrName=this.tagInfo.attr.name}query.usedAttr=HTMLUtils.getTagAttributes(this.editor,cursor)}if(query.tag&&query.queryStr!==null){var tagName=query.tag,attrName=query.attrName,filter=query.queryStr,unfiltered=[],hints;if(attrName){hints=this._getValueHintsForAttr(query,tagName,attrName)}else if(tags&&tags[tagName]&&tags[tagName].attributes){unfiltered=tags[tagName].attributes.concat(this.globalAttributes);hints=$.grep(unfiltered,function(attr,i){return $.inArray(attr,query.usedAttr)<0})}if(hints instanceof Array&&hints.length){console.assert(!result.length);result=$.map(hints,function(item){if(item.indexOf(filter)===0){return item}}).sort();return{hints:result,match:query.queryStr,selectInitial:true,handleWideResults:false}}else if(hints instanceof Object&&hints.hasOwnProperty("done")){var deferred=$.Deferred();hints.done(function(asyncHints){deferred.resolveWith(this,[{hints:asyncHints,match:query.queryStr,selectInitial:true,handleWideResults:false}])});return deferred}else{return null}}};AttrHints.prototype.insertHint=function(completion){var cursor=this.editor.getCursorPos(),start={line:-1,ch:-1},end={line:-1,ch:-1},tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,charCount=0,insertedName=false,replaceExistingOne=this.tagInfo.attr.valueAssigned,endQuote="",shouldReplace=true,textAfterCursor;if(tokenType===HTMLUtils.ATTR_NAME){textAfterCursor=this.tagInfo.attr.name.substr(offset);if(CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){charCount=offset;replaceExistingOne=false}else{charCount=this.tagInfo.attr.name.length}if(!replaceExistingOne&&attributes&&attributes[completion]&&attributes[completion].type!=="flag"){completion+='=""';insertedName=true}else if(completion===this.tagInfo.attr.name){shouldReplace=false}}else if(tokenType===HTMLUtils.ATTR_VALUE){textAfterCursor=this.tagInfo.attr.value.substr(offset);if(CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)){charCount=offset;this.exclusion=null}else{charCount=this.tagInfo.attr.value.length}if(!this.tagInfo.attr.hasEndQuote){endQuote=this.tagInfo.attr.quoteChar;if(endQuote){completion+=endQuote}else if(offset===0){completion='"'+completion+'"'}}else if(completion===this.tagInfo.attr.value){shouldReplace=false}}end.line=start.line=cursor.line;start.ch=cursor.ch-offset;end.ch=start.ch+charCount;if(shouldReplace){if(start.ch!==end.ch){this.editor.document.replaceRange(completion,start,end)}else{this.editor.document.replaceRange(completion,start)}}if(insertedName){this.editor.setCursorPos(start.line,start.ch+completion.length-1);return true}else if(tokenType===HTMLUtils.ATTR_VALUE&&this.tagInfo.attr.hasEndQuote){this.editor.setCursorPos(start.line,start.ch+completion.length+1)}return false};AppInit.appReady(function(){tags=JSON.parse(HTMLTags);attributes=JSON.parse(HTMLAttributes);var tagHints=new TagHints;var attrHints=new AttrHints;CodeHintManager.registerHintProvider(tagHints,["html"],0);CodeHintManager.registerHintProvider(attrHints,["html"],0);exports.tagHintProvider=tagHints;exports.attrHintProvider=attrHints})});