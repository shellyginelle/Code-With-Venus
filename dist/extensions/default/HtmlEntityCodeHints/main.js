define(function(require,exports,module){"use strict";var AppInit=brackets.getModule("utils/AppInit"),CodeHintManager=brackets.getModule("editor/CodeHintManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),HTMLUtils=brackets.getModule("language/HTMLUtils"),HtmlSpecialChars=require("text!SpecialChars.json"),specialChars;function _encodeValue(value){return value.replace("&","&amp;").replace("#","&#35;")}function _decodeValue(value){return value.replace("&amp;","&").replace("&#35;","#")}function SpecialCharHints(){this.primaryTriggerKeys="&ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz#0123456789";this.currentQuery=""}SpecialCharHints.prototype.hasHints=function(editor,implicitChar){this.editor=editor;return this._getQuery()!==null};SpecialCharHints.prototype.getHints=function(implicitChar){var query,result;if(implicitChar===null||this.primaryTriggerKeys.indexOf(implicitChar)!==-1){this.currentQuery=query=this._getQuery();result=$.map(specialChars,function(value,index){if(value.indexOf(query)===0){var shownValue=_encodeValue(value);return shownValue+"; <span class='entity-display-character'>"+value+";</span>"}}).sort(this._internalSort);if(query!==null){query=_encodeValue(query)}return{hints:result,match:query,selectInitial:true,handleWideResults:false}}return null};SpecialCharHints.prototype._internalSort=function(a,b){a=_decodeValue(a.slice(0,a.indexOf(" "))).toLowerCase();b=_decodeValue(b.slice(0,b.indexOf(" "))).toLowerCase();if(a.indexOf("#")!==-1&&b.indexOf("#")!==-1){var num1=parseInt(a.slice(a.indexOf("#")+1,a.length-1),10),num2=parseInt(b.slice(b.indexOf("#")+1,b.length-1),10);return num1-num2}return a.localeCompare(b)};SpecialCharHints.prototype._getQuery=function(){var query,lineContentBeforeCursor,startChar,endChar,cursor=this.editor.getCursorPos();if(HTMLUtils.getTagInfo(this.editor,cursor).tagName!==""){return null}lineContentBeforeCursor=this.editor.document.getRange({line:cursor.line,ch:0},cursor);startChar=lineContentBeforeCursor.lastIndexOf("&");endChar=lineContentBeforeCursor.lastIndexOf(";");if(startChar===-1||endChar>startChar){return null}query=this.editor.document.getRange({line:cursor.line,ch:startChar},cursor);return query};SpecialCharHints.prototype.insertHint=function(completion){var start={line:-1,ch:-1},end={line:-1,ch:-1},cursor=this.editor.getCursorPos(),line=this.editor.document.getLine(cursor.line),subLine,ampersandPos,semicolonPos,entityMatch;end.line=start.line=cursor.line;start.ch=cursor.ch-this.currentQuery.length;subLine=line.slice(cursor.ch);ampersandPos=subLine.indexOf("&");semicolonPos=subLine.indexOf(";");end.ch=start.ch+this.currentQuery.length;if(semicolonPos!==-1&&(ampersandPos===-1||ampersandPos>semicolonPos)){subLine=subLine.slice(0,semicolonPos);entityMatch=subLine.match(/^(#?[0-9]+)|([a-zA-Z]+)$/);if(entityMatch&&entityMatch.length>0&&entityMatch.index===0&&entityMatch[0].length===subLine.length){end.ch=line.indexOf(";",start.ch)+1}}completion=completion.slice(0,completion.indexOf(" "));completion=_decodeValue(completion);if(start.ch!==end.ch){this.editor.document.replaceRange(completion,start,end)}else{this.editor.document.replaceRange(completion,start)}return false};AppInit.appReady(function(){ExtensionUtils.loadStyleSheet(module,"styles.css");specialChars=JSON.parse(HtmlSpecialChars);var specialCharHints=new SpecialCharHints;CodeHintManager.registerHintProvider(specialCharHints,["html"],1)});exports.SpecialCharHints=SpecialCharHints});