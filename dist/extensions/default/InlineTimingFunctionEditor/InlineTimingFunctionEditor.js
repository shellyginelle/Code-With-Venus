define(function(require,exports,module){"use strict";var InlineWidget=brackets.getModule("editor/InlineWidget").InlineWidget,BezierCurveEditor=require("BezierCurveEditor").BezierCurveEditor,StepEditor=require("StepEditor").StepEditor,TimingFunctionUtils=require("TimingFunctionUtils");var lastOriginId=1;function InlineTimingFunctionEditor(timingFunction,startBookmark,endBookmark){this._timingFunction=timingFunction;this._startBookmark=startBookmark;this._endBookmark=endBookmark;this._isOwnChange=false;this._isHostChange=false;this._origin="+InlineTimingFunctionEditor_"+lastOriginId++;this._handleTimingFunctionChange=this._handleTimingFunctionChange.bind(this);this._handleHostDocumentChange=this._handleHostDocumentChange.bind(this);InlineWidget.call(this)}InlineTimingFunctionEditor.prototype=Object.create(InlineWidget.prototype);InlineTimingFunctionEditor.prototype.constructor=InlineTimingFunctionEditor;InlineTimingFunctionEditor.prototype.parentClass=InlineWidget.prototype;InlineTimingFunctionEditor.prototype.timingFunctionEditor=null;InlineTimingFunctionEditor.prototype._timingFunction=null;InlineTimingFunctionEditor.prototype._startBookmark=null;InlineTimingFunctionEditor.prototype._endBookmark=null;InlineTimingFunctionEditor.prototype._isOwnChange=null;InlineTimingFunctionEditor.prototype._isHostChange=null;InlineTimingFunctionEditor.prototype._origin=null;InlineTimingFunctionEditor.prototype.getCurrentRange=function(){var start,end;start=this._startBookmark.find();if(!start){return null}end=this._endBookmark.find();if(!end){end={line:start.line}}var line=this.hostEditor.document.getLine(start.line),matches=TimingFunctionUtils.timingFunctionMatch(line.substr(start.ch),true),originalLength;if(!matches){return null}originalLength=matches.originalString&&matches.originalString.length||matches[0].length;if(end.ch===undefined||end.ch-start.ch!==originalLength){end.ch=start.ch+originalLength;this._endBookmark.clear();this._endBookmark=this.hostEditor._codeMirror.setBookmark(end)}if(end.ch===undefined){return null}else{return{start:start,end:end,match:matches,originalLength:originalLength}}};InlineTimingFunctionEditor.prototype._handleTimingFunctionChange=function(timingFunctionString){var self=this,timingFunctionMatch=TimingFunctionUtils.timingFunctionMatch(timingFunctionString,true);if(timingFunctionMatch!==this._timingFunction){var range=this.getCurrentRange();if(!range){return}if(!this._isHostChange){this._isOwnChange=true;this.hostEditor.document.batchOperation(function(){self.hostEditor.document.replaceRange(timingFunctionString,range.start,range.end,self._origin);var newEnd={line:range.start.line,ch:range.start.ch+timingFunctionString.length};self.hostEditor.setSelection(range.start,newEnd,false,0,self._origin)});this._isOwnChange=false}this._timingFunction=timingFunctionMatch}};InlineTimingFunctionEditor.prototype.load=function(hostEditor){InlineTimingFunctionEditor.prototype.parentClass.load.apply(this,arguments);if(this._timingFunction.isBezier){this.timingFunctionEditor=new BezierCurveEditor(this.$htmlContent,this._timingFunction,this._handleTimingFunctionChange)}else if(this._timingFunction.isStep){this.timingFunctionEditor=new StepEditor(this.$htmlContent,this._timingFunction,this._handleTimingFunctionChange)}else{window.console.log("InlineTimingFunctionEditor.load tried to load an unkown timing function type")}};InlineTimingFunctionEditor.prototype.onAdded=function(){InlineTimingFunctionEditor.prototype.parentClass.onAdded.apply(this,arguments);var doc=this.hostEditor.document;doc.addRef();doc.on("change",this._handleHostDocumentChange);this.hostEditor.setInlineWidgetHeight(this,this.timingFunctionEditor.getRootElement().outerHeight(),true);this.timingFunctionEditor.focus()};InlineTimingFunctionEditor.prototype.onClosed=function(){InlineTimingFunctionEditor.prototype.parentClass.onClosed.apply(this,arguments);this.timingFunctionEditor.destroy();if(this._startBookmark){this._startBookmark.clear()}if(this._endBookmark){this._endBookmark.clear()}var doc=this.hostEditor.document;doc.off("change",this._handleHostDocumentChange);doc.releaseRef()};InlineTimingFunctionEditor.prototype._handleHostDocumentChange=function(){if(this._isOwnChange){return}var range=this.getCurrentRange();if(range){if(range.match!==this._timingFunction){this._isHostChange=true;this._isHostChange=false;this._timingFunction=range.match;this.timingFunctionEditor.handleExternalUpdate(range.match)}}else{this.close()}};exports.InlineTimingFunctionEditor=InlineTimingFunctionEditor});