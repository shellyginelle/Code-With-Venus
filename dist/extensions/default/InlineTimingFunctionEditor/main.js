define(function(require,exports,module){"use strict";var EditorManager=brackets.getModule("editor/EditorManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),Strings=brackets.getModule("strings"),InlineTimingFunctionEditor=require("InlineTimingFunctionEditor").InlineTimingFunctionEditor,TimingFunctionUtils=require("TimingFunctionUtils"),Localized=require("text!Localized.css");function prepareEditorForProvider(hostEditor,pos){var cursorLine,sel,startPos,endPos,startBookmark,endBookmark,currentMatch,cm=hostEditor._codeMirror;sel=hostEditor.getSelection();if(sel.start.line!==sel.end.line){return{timingFunction:null,reason:null}}cursorLine=hostEditor.document.getLine(pos.line);if(!cursorLine.match(/cubic-bezier|linear|ease|step/)){return{timingFunction:null,reason:null}}currentMatch=TimingFunctionUtils.timingFunctionMatch(cursorLine,false);if(!currentMatch){return{timingFunction:null,reason:Strings.ERROR_TIMINGQUICKEDIT_INVALIDSYNTAX}}var lineOffset=0,matchLength=currentMatch.originalString&&currentMatch.originalString.length||currentMatch[0].length;while(pos.ch>currentMatch.index+matchLength+lineOffset){var restOfLine=cursorLine.substring(currentMatch.index+matchLength+lineOffset),newMatch=TimingFunctionUtils.timingFunctionMatch(restOfLine,false);if(newMatch){lineOffset+=currentMatch.index+matchLength;currentMatch=$.extend(true,[],newMatch)}else{break}}currentMatch.lineOffset=lineOffset;startPos={line:pos.line,ch:lineOffset+currentMatch.index};endPos={line:pos.line,ch:lineOffset+currentMatch.index+matchLength};startBookmark=cm.setBookmark(startPos);endBookmark=cm.setBookmark(endPos);hostEditor.setSelection(startPos,endPos);return{timingFunction:currentMatch,start:startBookmark,end:endBookmark}}function inlineTimingFunctionEditorProvider(hostEditor,pos){var context=prepareEditorForProvider(hostEditor,pos),inlineTimingFunctionEditor,result;if(!context.timingFunction){return context.reason||null}else{inlineTimingFunctionEditor=new InlineTimingFunctionEditor(context.timingFunction,context.start,context.end);inlineTimingFunctionEditor.load(hostEditor);result=new $.Deferred;result.resolve(inlineTimingFunctionEditor);return result.promise()}}function init(){ExtensionUtils.loadStyleSheet(module,"main.less");ExtensionUtils.addEmbeddedStyleSheet(Mustache.render(Localized,Strings));EditorManager.registerInlineEditProvider(inlineTimingFunctionEditorProvider)}init();exports.inlineTimingFunctionEditorProvider=inlineTimingFunctionEditorProvider});