define(function(require,exports,module){"use strict";var StringMatch=brackets.getModule("utils/StringMatch"),LanguageManager=brackets.getModule("language/LanguageManager"),HTMLUtils=brackets.getModule("language/HTMLUtils"),HintUtils=require("HintUtils"),ScopeManager=require("ScopeManager"),Acorn=require("thirdparty/acorn/acorn"),Acorn_Loose=require("thirdparty/acorn/acorn_loose");function Session(editor){this.editor=editor;this.path=editor.document.file.fullPath;this.ternHints=[];this.ternGuesses=null;this.fnType=null;this.builtins=null}Session.prototype._getBuiltins=function(){if(!this.builtins){this.builtins=ScopeManager.getBuiltins();this.builtins.push("requirejs.js")}return this.builtins};Session.prototype.getPath=function(){return this.path};Session.prototype.getCursor=function(){return this.editor.getCursorPos()};Session.prototype.getLine=function(line){var doc=this.editor.document;return doc.getLine(line)};Session.prototype.getOffset=function(){var cursor=this.getCursor();return this.getOffsetFromCursor(cursor)};Session.prototype.getOffsetFromCursor=function(cursor){return this.editor.indexFromPos(cursor)};Session.prototype.getToken=function(cursor){var cm=this.editor._codeMirror;if(cursor){return cm.getTokenAt(cursor)}else{return cm.getTokenAt(this.getCursor())}};Session.prototype.getNextTokenOnLine=function(cursor){cursor=this.getNextCursorOnLine(cursor);if(cursor){return this.getToken(cursor)}return null};Session.prototype.getNextCursorOnLine=function(cursor){var doc=this.editor.document,line=doc.getLine(cursor.line);if(cursor.ch<line.length){return{ch:cursor.ch+1,line:cursor.line}}else{return null}};Session.prototype._getPreviousToken=function(cursor){var token=this.getToken(cursor),prev=token,doc=this.editor.document;do{if(prev.start<cursor.ch){cursor.ch=prev.start}else if(prev.start>0){cursor.ch=prev.start-1}else if(cursor.line>0){cursor.ch=doc.getLine(cursor.line-1).length;cursor.line--}else{break}prev=this.getToken(cursor)}while(!/\S/.test(prev.string));return prev};Session.prototype.getNextToken=function(cursor,skipWhitespace){var token=this.getToken(cursor),next=token,doc=this.editor.document;do{if(next.end>cursor.ch){cursor.ch=next.end}else if(next.end<doc.getLine(cursor.line).length){cursor.ch=next.end+1}else if(doc.getLine(cursor.line+1)){cursor.ch=0;cursor.line++}else{next=null;break}next=this.getToken(cursor)}while(skipWhitespace&&!/\S/.test(next.string));return next};Session.prototype.getQuery=function(){var cursor=this.getCursor(),token=this.getToken(cursor),query="",start=cursor.ch,end=start;if(token){var line=this.getLine(cursor.line);while(start>0){if(HintUtils.maybeIdentifier(line[start-1])){start--}else{break}}query=line.substring(start,end)}return query};Session.prototype.getContext=function(cursor,depth){var token=this.getToken(cursor);if(depth===undefined){depth=0}if(token.string===")"){this._getPreviousToken(cursor);return this.getContext(cursor,++depth)}else if(token.string==="("){this._getPreviousToken(cursor);return this.getContext(cursor,--depth)}else{if(depth>0||token.string==="."){this._getPreviousToken(cursor);return this.getContext(cursor,depth)}else{return token.string}}};Session.prototype.findPreviousDot=function(){var cursor=this.getCursor(),token=this.getToken(cursor);if(token&&token.string==="."){return cursor}else{token=this._getPreviousToken(cursor);if(token&&token.string==="."){return cursor}}return undefined};function getLexicalState(token){if(token.state.lexical){return token.state.lexical}else if(token.state.localState&&token.state.localState.lexical){return token.state.localState.lexical}}Session.prototype.getFunctionInfo=function(){var inFunctionCall=false,cursor=this.getCursor(),functionCallPos,token=this.getToken(cursor),lexical,self=this,foundCall=false;function isOnFunctionIdentifier(){var type=token.type,nextToken,localLexical,localCursor={line:cursor.line,ch:token.end};if(type==="variable-2"||type==="variable"||type==="property"){nextToken=self.getNextToken(localCursor,true);if(nextToken&&nextToken.string==="("){localLexical=getLexicalState(nextToken);return localLexical}}return null}function isInFunctionalCall(lex){return lex&&(lex.info==="call"||lex.info===undefined&&(lex.type==="]"||lex.type==="}")&&lex.prev.info==="call")}if(token){lexical=getLexicalState(token);foundCall=isInFunctionalCall(lexical);if(!foundCall){lexical=isOnFunctionIdentifier();foundCall=isInFunctionalCall(lexical)}if(foundCall){if(lexical.info===undefined){lexical=lexical.prev}var col=lexical.info==="call"?lexical.column:lexical.prev.column,line,e,found;for(line=this.getCursor().line,e=Math.max(0,line-9),found=false;line>=e;--line){if(this.getLine(line).charAt(col)==="("){found=true;break}}if(found){inFunctionCall=true;functionCallPos={line:line,ch:col}}}}return{inFunctionCall:inFunctionCall,functionCallPos:functionCallPos}};Session.prototype.getType=function(){var propertyLookup=false,context=null,cursor=this.getCursor(),token=this.getToken(cursor),lexical;if(token){lexical=getLexicalState(token);if(token.type==="property"){propertyLookup=true}cursor=this.findPreviousDot();if(cursor){propertyLookup=true;context=this.getContext(cursor)}}return{property:propertyLookup,context:context}};function penalizeUnderscoreValueCompare(a,b){var aName=a.value.toLowerCase(),bName=b.value.toLowerCase();if(aName[0]==="_"&&bName[0]!=="_"){return 1}else if(bName[0]==="_"&&aName[0]!=="_"){return-1}if(aName<bName){return-1}else if(aName>bName){return 1}return 0}Session.prototype.getHints=function(query,matcher){if(query===undefined){query=""}var MAX_DISPLAYED_HINTS=500,type=this.getType(),builtins=this._getBuiltins(),needGuesses=false,hints;function isBuiltin(origin){return builtins.indexOf(origin)!==-1}function filterWithQueryAndMatcher(hints,matcher){var matchResults=$.map(hints,function(hint){var searchResult=matcher.match(hint.value,query);if(searchResult){searchResult.value=hint.value;searchResult.guess=hint.guess;searchResult.type=hint.type;if(hint.keyword!==undefined){searchResult.keyword=hint.keyword}if(hint.literal!==undefined){searchResult.literal=hint.literal}if(hint.depth!==undefined){searchResult.depth=hint.depth}if(!type.property&&!type.showFunctionType&&hint.origin&&isBuiltin(hint.origin)){searchResult.builtin=1}else{searchResult.builtin=0}}return searchResult});return matchResults}if(type.property){hints=this.ternHints||[];hints=filterWithQueryAndMatcher(hints,matcher);if(hints.length===0){if(this.ternGuesses){hints=filterWithQueryAndMatcher(this.ternGuesses,matcher)}else{needGuesses=true}}StringMatch.multiFieldSort(hints,["matchGoodness",penalizeUnderscoreValueCompare])}else{hints=this.ternHints||[];hints=hints.concat(HintUtils.LITERALS);hints=hints.concat(HintUtils.KEYWORDS);hints=filterWithQueryAndMatcher(hints,matcher);StringMatch.multiFieldSort(hints,["matchGoodness","depth","builtin",penalizeUnderscoreValueCompare])}if(hints.length>MAX_DISPLAYED_HINTS){hints=hints.slice(0,MAX_DISPLAYED_HINTS)}return{hints:hints,needGuesses:needGuesses}};Session.prototype.setTernHints=function(newHints){this.ternHints=newHints};Session.prototype.setGuesses=function(newGuesses){this.ternGuesses=newGuesses};Session.prototype.setFnType=function(newFnType){this.fnType=newFnType};Session.prototype.setFunctionCallPos=function(functionCallPos){this.functionCallPos=functionCallPos};Session.prototype.getParameterHint=function(){var fnHint=this.fnType,cursor=this.getCursor(),token=this.getToken(this.functionCallPos),start={line:this.functionCallPos.line,ch:token.start},fragment=this.editor.document.getRange(start,{line:this.functionCallPos.line+10,ch:0});var ast;try{ast=Acorn.parse(fragment)}catch(e){ast=Acorn_Loose.parse_dammit(fragment)}var startOffset=this.getOffsetFromCursor(start),cursorOffset=this.getOffsetFromCursor(cursor),offset=cursorOffset-startOffset,node=ast.body[0],currentArg=-1;if(node.type==="ExpressionStatement"){node=node.expression;if(node.type==="SequenceExpression"){node=node.expressions[0]}if(node.type==="BinaryExpression"){if(node.left.type==="CallExpression"){node=node.left}else if(node.right.type==="CallExpression"){node=node.right}}if(node.type==="CallExpression"){var args=node["arguments"],i,n=args.length,lastEnd=offset,text;for(i=0;i<n;i++){node=args[i];if(offset>=node.start&&offset<=node.end){currentArg=i;break}else if(offset<node.start){text=fragment.substring(lastEnd,node.start);if(text.indexOf(",")>=offset-lastEnd){i--}else if(i===0&&text.indexOf("(")!==-1){currentArg=-1;break}currentArg=Math.max(0,i);break}else if(i+1===n){text=fragment.substring(node.end,offset);if(text.indexOf(",")!==-1){currentArg=i+1}}lastEnd=node.end}if(n===0&&cursorOffset>this.getOffsetFromCursor(this.functionCallPos)){currentArg=0}}}return{parameters:fnHint,currentIndex:currentArg}};Session.prototype.getJavascriptText=function(){if(LanguageManager.getLanguageForPath(this.editor.document.file.fullPath).getId()==="html"){var text="",editor=this.editor,scriptBlocks=HTMLUtils.findBlocks(editor,"javascript");var htmlStart={line:0,ch:0};scriptBlocks.forEach(function(scriptBlock){var start=scriptBlock.start,end=scriptBlock.end;var htmlText=editor.document.getRange(htmlStart,start);htmlText=htmlText.replace(/./g," ");htmlStart=end;text+=htmlText+scriptBlock.text});return text}else{return this.editor.document.getText()}};Session.prototype.isFunctionName=function(){var cursor=this.getCursor(),prevToken=this._getPreviousToken(cursor);return prevToken.string==="function"};module.exports=Session});