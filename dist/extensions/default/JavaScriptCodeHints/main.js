define(function(require,exports,module){"use strict";var _=brackets.getModule("thirdparty/lodash");var CodeHintManager=brackets.getModule("editor/CodeHintManager"),EditorManager=brackets.getModule("editor/EditorManager"),Commands=brackets.getModule("command/Commands"),CommandManager=brackets.getModule("command/CommandManager"),LanguageManager=brackets.getModule("language/LanguageManager"),AppInit=brackets.getModule("utils/AppInit"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),StringMatch=brackets.getModule("utils/StringMatch"),ProjectManager=brackets.getModule("project/ProjectManager"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),ParameterHintManager=require("ParameterHintManager"),HintUtils=require("HintUtils"),ScopeManager=require("ScopeManager"),Session=require("Session"),Acorn=require("thirdparty/acorn/acorn");var session=null,cachedCursor=null,cachedHints=null,cachedType=null,cachedToken=null,matcher=null,jsHintsEnabled=true,noHintsOnDot=false,ignoreChange;PreferencesManager.definePreference("jscodehints.detectedExclusions","array",[]);PreferencesManager.definePreference("jscodehints.inferenceTimeout","number",3e4);PreferencesManager.definePreference("jscodehints.noHintsOnDot","boolean",false);PreferencesManager.definePreference("codehint.JSHints","boolean",true);function _areHintsEnabled(){return PreferencesManager.get("codehint.JSHints")!==false&&PreferencesManager.get("showCodeHints")!==false}PreferencesManager.on("change","codehint.JSHints",function(){jsHintsEnabled=_areHintsEnabled()});PreferencesManager.on("change","showCodeHints",function(){jsHintsEnabled=_areHintsEnabled()});PreferencesManager.on("change","jscodehints.noHintsOnDot",function(){noHintsOnDot=!!PreferencesManager.get("jscodehints.noHintsOnDot")});function setConfig(configUpdate){var config=setConfig.config;Object.keys(configUpdate).forEach(function(key){config[key]=configUpdate[key]});ScopeManager._setConfig(configUpdate)}setConfig.config={};function getSession(){return session}function getHintResponse(hints,query,type){var trimmedQuery,formattedHints;if(setConfig.config.debug){console.debug("Hints",_.pluck(hints,"label"))}function formatHints(hints,query){return hints.map(function(token){var $hintObj=$("<span>").addClass("brackets-js-hints");if(!type.property&&!token.builtin&&token.depth!==undefined){switch(token.depth){case 0:$hintObj.addClass("priority-high");break;case 1:$hintObj.addClass("priority-medium");break;case 2:$hintObj.addClass("priority-low");break;default:$hintObj.addClass("priority-lowest");break}}if(token.guess){$hintObj.addClass("guess-hint")}if(token.keyword){$hintObj.addClass("keyword-hint")}if(token.literal){$hintObj.addClass("literal-hint")}if(token.stringRanges){token.stringRanges.forEach(function(item){if(item.matched){$hintObj.append($("<span>").append(_.escape(item.text)).addClass("matched-hint"))}else{$hintObj.append(_.escape(item.text))}})}else{$hintObj.text(token.value)}$hintObj.data("token",token);return $hintObj})}if(query.indexOf(HintUtils.SINGLE_QUOTE)===0||query.indexOf(HintUtils.DOUBLE_QUOTE)===0){trimmedQuery=query.substring(1);if(trimmedQuery.lastIndexOf(HintUtils.DOUBLE_QUOTE)===trimmedQuery.length-1||trimmedQuery.lastIndexOf(HintUtils.SINGLE_QUOTE)===trimmedQuery.length-1){trimmedQuery=trimmedQuery.substring(0,trimmedQuery.length-1)}}else{trimmedQuery=query}if(hints){formattedHints=formatHints(hints,trimmedQuery)}else{formattedHints=[]}return{hints:formattedHints,match:null,selectInitial:true,handleWideResults:hints.handleWideResults}}function JSHints(){}JSHints.prototype.needNewHints=function(session){var cursor=session.getCursor(),type=session.getType();return!cachedHints||!cachedCursor||!cachedType||cachedCursor.line!==cursor.line||type.property!==cachedType.property||type.context!==cachedType.context||type.showFunctionType!==cachedType.showFunctionType||type.functionCallPos&&cachedType.functionCallPos&&type.functionCallPos.ch!==cachedType.functionCallPos.ch};function setCachedHintContext(hints,cursor,type,token){cachedHints=hints;cachedCursor=cursor;cachedType=type;cachedToken=token}function resetCachedHintContext(){cachedHints=null;cachedCursor=null;cachedType=null;cachedToken=null}JSHints.prototype.shouldCloseHints=function(session){var cursor=session.getCursor(),token=session.getToken(cursor),lastToken=cachedToken;if(!cachedCursor||cursor.line!==cachedCursor.line){return true}if(token.type===null){token=session.getNextTokenOnLine(cursor)}if(lastToken&&lastToken.type===null){lastToken=session.getNextTokenOnLine(cachedCursor)}if(!lastToken||!token||token.type!==lastToken.type){return true}if(token.string.length>=lastToken.string.length){return token.string.indexOf(lastToken.string)!==0}else{return lastToken.string.indexOf(token.string)!==0}};function isHTMLFile(document){return LanguageManager.getLanguageForPath(document.file.fullPath).getId()==="html"}function isInlineScript(editor){return editor.getModeForSelection()==="javascript"}function getStringMatcher(){if(!matcher){matcher=new StringMatch.StringMatcher({preferPrefixMatches:true})}return matcher}function hintsArePending(deferredHints){return deferredHints&&!deferredHints.hasOwnProperty("hints")&&deferredHints.state()==="pending"}function getSessionHints(query,cursor,type,token,$deferredHints){var hintResults=session.getHints(query,getStringMatcher());if(hintResults.needGuesses){var guessesResponse=ScopeManager.requestGuesses(session,session.editor.document);if(!$deferredHints){$deferredHints=$.Deferred()}guessesResponse.done(function(){if(hintsArePending($deferredHints)){hintResults=session.getHints(query,getStringMatcher());setCachedHintContext(hintResults.hints,cursor,type,token);var hintResponse=getHintResponse(cachedHints,query,type);$deferredHints.resolveWith(null,[hintResponse])}}).fail(function(){if(hintsArePending($deferredHints)){$deferredHints.reject()}});return $deferredHints}else if(hintsArePending($deferredHints)){setCachedHintContext(hintResults.hints,cursor,type,token);var hintResponse=getHintResponse(cachedHints,query,type);$deferredHints.resolveWith(null,[hintResponse]);return null}else{setCachedHintContext(hintResults.hints,cursor,type,token);return getHintResponse(cachedHints,query,type)}}JSHints.prototype.hasHints=function(editor,key){if(session&&HintUtils.hintableKey(key,!noHintsOnDot)){if(isHTMLFile(session.editor.document)){if(!isInlineScript(session.editor)){return false}}var cursor=session.getCursor(),token=session.getToken(cursor);if(token&&HintUtils.hintable(token)){if(session.isFunctionName()){return false}if(this.needNewHints(session)){resetCachedHintContext();matcher=null}return true}}return false};JSHints.prototype.getHints=function(key){var cursor=session.getCursor(),token=session.getToken(cursor);if(token&&HintUtils.hintableKey(key,!noHintsOnDot)&&HintUtils.hintable(token)){var type=session.getType(),query=session.getQuery();if(CodeHintManager.isOpen()&&this.shouldCloseHints(session)){return null}if(this.needNewHints(session)){if(key){ScopeManager.handleFileChange([{from:cursor,to:cursor,text:[key]}]);ignoreChange=true}var scopeResponse=ScopeManager.requestHints(session,session.editor.document),$deferredHints=$.Deferred(),scopeSession=session;scopeResponse.done(function(){if(hintsArePending($deferredHints)){if(scopeSession===session){getSessionHints(query,cursor,type,token,$deferredHints)}else{$deferredHints.reject()}}scopeSession=null}).fail(function(){if(hintsArePending($deferredHints)){$deferredHints.reject()}scopeSession=null});return $deferredHints}if(cachedHints){return getSessionHints(query,cursor,type,token)}}return null};JSHints.prototype.insertHint=function($hintObj){var hint=$hintObj.data("token"),completion=hint.value,cursor=session.getCursor(),query=session.getQuery(),start={line:cursor.line,ch:cursor.ch-query.length},end={line:cursor.line,ch:cursor.ch},invalidPropertyName=false;if(session.getType().property){var tokenizer=Acorn.tokenize(completion);var currentToken=tokenizer();if(currentToken.type!==Acorn.tokTypes.name&&!currentToken.type.keyword){invalidPropertyName=true}else{currentToken=tokenizer();if(currentToken.type!==Acorn.tokTypes.eof){invalidPropertyName=true}}if(invalidPropertyName){var dotCursor=session.findPreviousDot();if(dotCursor){completion='["'+completion+'"]';start.line=dotCursor.line;start.ch=dotCursor.ch-1}}}session.editor._codeMirror.replaceRange(completion,start,end);return false};AppInit.appReady(function(){function initializeSession(editor,previousEditor){session=new Session(editor);ScopeManager.handleEditorChange(session,editor.document,previousEditor?previousEditor.document:null);ParameterHintManager.setSession(session);cachedHints=null}function installEditorListeners(editor,previousEditor){resetCachedHintContext();if(!jsHintsEnabled){return}if(editor&&HintUtils.isSupportedLanguage(LanguageManager.getLanguageForPath(editor.document.file.fullPath).getId())){initializeSession(editor,previousEditor);editor.on(HintUtils.eventName("change"),function(event,editor,changeList){if(!ignoreChange){ScopeManager.handleFileChange(changeList);ParameterHintManager.popUpHintAtOpenParen()}ignoreChange=false});ParameterHintManager.installListeners(editor)}else{session=null}}function uninstallEditorListeners(editor){if(editor){editor.off(HintUtils.eventName("change"))}}function handleActiveEditorChange(event,current,previous){if(previous){previous.document.off(HintUtils.eventName("languageChanged"))}if(current){current.document.on(HintUtils.eventName("languageChanged"),function(){uninstallEditorListeners(current);installEditorListeners(current)})}uninstallEditorListeners(previous);installEditorListeners(current,previous)}function handleJumpToDefinition(){var offset,handleJumpResponse;if(!session||session.editor.getModeForSelection()!=="javascript"){return null}var result=new $.Deferred;function requestJumpToDef(session,offset){var response=ScopeManager.requestJumptoDef(session,session.editor.document,offset);if(response.hasOwnProperty("promise")){response.promise.done(handleJumpResponse).fail(function(){result.reject()})}}function setJumpSelection(start,end,isFunction){function validIdOrProp(token){if(!token){return false}if(token.string==="."){return true}var type=token.type;if(type==="variable-2"||type==="variable"||type==="property"){return true}return false}var madeNewRequest=false;if(isFunction){var cursor={line:end.line,ch:end.ch},prev=session._getPreviousToken(cursor),next,offset;if(prev.string==="."){cursor={line:end.line,ch:end.ch};next=session.getNextToken(cursor,true);if(next&&next.string==="="){next=session.getNextToken(cursor,true);while(validIdOrProp(next)){offset=session.getOffsetFromCursor({line:cursor.line,ch:next.end});next=session.getNextToken(cursor,false)}if(offset){requestJumpToDef(session,offset);madeNewRequest=true}}}}if(!madeNewRequest){session.editor.setSelection(start,end,true);result.resolve(true)}}handleJumpResponse=function(jumpResp){if(jumpResp.resultFile){if(jumpResp.resultFile!==jumpResp.file){var resolvedPath=ScopeManager.getResolvedPath(jumpResp.resultFile);if(resolvedPath){CommandManager.execute(Commands.FILE_OPEN,{fullPath:resolvedPath}).done(function(){setJumpSelection(jumpResp.start,jumpResp.end,jumpResp.isFunction)})}}else{setJumpSelection(jumpResp.start,jumpResp.end,jumpResp.isFunction)}}else{result.reject()}};offset=session.getOffset();requestJumpToDef(session,offset);return result.promise()}function quickEditHelper(){var offset=session.getCursor(),response=ScopeManager.requestJumptoDef(session,session.editor.document,offset);return response}brackets._jsCodeHintsHelper=quickEditHelper;brackets._configureJSCodeHints=setConfig;ExtensionUtils.loadStyleSheet(module,"styles/brackets-js-hints.css");EditorManager.on(HintUtils.eventName("activeEditorChange"),handleActiveEditorChange);ProjectManager.on("beforeProjectClose",function(){ScopeManager.handleProjectClose()});ProjectManager.on("projectOpen",function(){ScopeManager.handleProjectOpen()});installEditorListeners(EditorManager.getActiveEditor());EditorManager.registerJumpToDefProvider(handleJumpToDefinition);var jsHints=new JSHints;CodeHintManager.registerHintProvider(jsHints,HintUtils.SUPPORTED_LANGUAGES,0);ParameterHintManager.addCommands();exports.getSession=getSession;exports.jsHintProvider=jsHints;exports.initializeSession=initializeSession;exports.handleJumpToDefinition=handleJumpToDefinition})});