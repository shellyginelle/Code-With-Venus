define(function(require,exports,module){"use strict";var ColorUtils=brackets.getModule("utils/ColorUtils"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),CSSUtils=brackets.getModule("language/CSSUtils"),EditorManager=brackets.getModule("editor/EditorManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),FileUtils=brackets.getModule("file/FileUtils"),Menus=brackets.getModule("command/Menus"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),LanguageManager=brackets.getModule("language/LanguageManager"),Strings=brackets.getModule("strings"),ViewUtils=brackets.getModule("utils/ViewUtils"),TokenUtils=brackets.getModule("utils/TokenUtils"),Path=brackets.getModule("filesystem/impls/filer/BracketsFiler").Path,BlobUtils=brackets.getModule("filesystem/impls/filer/BlobUtils");var previewContainerHTML=require("text!QuickViewTemplate.html");var enabled,prefs=null,$previewContainer,$previewContent,lastMousePos,animationRequest,extensionlessImagePreview;var CMD_ENABLE_QUICK_VIEW="view.enableQuickView",HOVER_DELAY=350,POINTER_HEIGHT=15,POPOVER_HORZ_MARGIN=5;var styleLanguages=["css","text/x-less","sass","text/x-scss"];prefs=PreferencesManager.getExtensionPrefs("quickview");prefs.definePreference("enabled","boolean",true);prefs.definePreference("extensionlessImagePreview","boolean",true);var popoverState=null;function hidePreview(){if(!popoverState){return}if(popoverState.visible){popoverState.marker.clear();$previewContent.empty();$previewContainer.hide();$previewContainer.removeClass("active")}else{window.clearTimeout(popoverState.hoverTimer)}popoverState=null}function positionPreview(editor,xpos,ypos,ybot){var previewWidth=$previewContainer.outerWidth(),top=ypos-$previewContainer.outerHeight()-POINTER_HEIGHT,left=xpos-previewWidth/2,elementRect={top:top,left:left-POPOVER_HORZ_MARGIN,height:$previewContainer.outerHeight()+POINTER_HEIGHT,width:previewWidth+2*POPOVER_HORZ_MARGIN},clip=ViewUtils.getElementClipSize($(editor.getRootElement()),elementRect);if(clip.left>0){left+=clip.left}else if(clip.right>0){left-=clip.right}if(clip.top>0){top=ybot+POINTER_HEIGHT;$previewContainer.removeClass("preview-bubble-above").addClass("preview-bubble-below")}else{$previewContainer.removeClass("preview-bubble-below").addClass("preview-bubble-above")}$previewContainer.css({left:left,top:top}).addClass("active")}function divContainsMouse($div,mousePos){var offset=$div.offset();return mousePos.clientX>=offset.left&&mousePos.clientX<=offset.left+$div.width()&&mousePos.clientY>=offset.top&&mousePos.clientY<=offset.top+$div.height()}function colorAndGradientPreviewProvider(editor,pos,token,line){var gradientRegEx=/-webkit-gradient\((?:[^\(]*?(?:\((?:[^\(]*?(?:\([^\)]*?\))*?)*?\))*?)*?\)|(?:(?:-moz-|-ms-|-o-|-webkit-|:|\s)((repeating-)?linear-gradient)|(?:-moz-|-ms-|-o-|-webkit-|:|\s)((repeating-)?radial-gradient))(\((?:[^\)]*?(?:\([^\)]*?\))*?)*?\))/gi,colorRegEx=new RegExp(ColorUtils.COLOR_REGEX),mode=TokenUtils.getModeAt(editor._codeMirror,pos,false),isStyleSheet=styleLanguages.indexOf(mode)!==-1;function areParensBalanced(str){var i,nestLevel=0,len;if(isStyleSheet){str=CSSUtils.reduceStyleSheetForRegExParsing(str)}len=str.length;for(i=0;i<len;i++){switch(str[i]){case"(":nestLevel++;break;case")":nestLevel--;break;case"\\":i++;break}}return nestLevel===0}function execGradientMatch(line,parensBalanced){var gradientMatch=parensBalanced?gradientRegEx.exec(line):null,prefix="",colorValue;if(gradientMatch){if(gradientMatch[0].indexOf("@")!==-1){gradientMatch=null}else{if(gradientMatch[0].match(/-o-|-moz-|-ms-|-webkit-/i)){prefix="-webkit-"}if(gradientMatch[1]){colorValue=gradientMatch[1]+gradientMatch[5]}else if(gradientMatch[3]){colorValue=gradientMatch[3]+gradientMatch[5]}else if(gradientMatch[0]){colorValue=gradientMatch[0];prefix=""}}}return{match:gradientMatch,prefix:prefix,colorValue:colorValue}}function execColorMatch(editor,line,pos){var colorMatch,ignoreNamedColors;function hyphenOnMatchBoundary(match,line){var beforeIndex,afterIndex;if(match){beforeIndex=match.index-1;if(beforeIndex>=0&&line[beforeIndex]==="-"){return true}else{afterIndex=match.index+match[0].length;if(afterIndex<line.length&&line[afterIndex]==="-"){return true}}}return false}function isNamedColor(match){if(match&&match[0]&&/^[a-z]+$/i.test(match[0])){return true}}do{colorMatch=colorRegEx.exec(line);if(!colorMatch){break}if(ignoreNamedColors===undefined){var mode=TokenUtils.getModeAt(editor._codeMirror,pos,false).name;ignoreNamedColors=styleLanguages.indexOf(mode)===-1}}while(hyphenOnMatchBoundary(colorMatch,line)||ignoreNamedColors&&isNamedColor(colorMatch));return colorMatch}function splitStyleProperty(property){var token=/((?:[^"']|".*?"|'.*?')*?)([(,)]|$)/g;var recurse=function(){var array=[];for(;;){var result=token.exec(property);if(result[2]==="("){var str=result[1].trim()+"("+recurse().join(",")+")";result=token.exec(property);str+=result[1];array.push(str)}else{array.push(result[1].trim())}if(result[2]!==","){return array}}};return recurse()}function isGradientColorStop(args){return args.length>0&&args[0].match(colorRegEx)!==null}function hasLengthInPixels(args){return args.length>1&&args[1].indexOf("px")>0}function normalizeGradientExpressionForQuickview(expression){if(expression.indexOf("px")>0){var paramStart=expression.indexOf("(")+1,paramEnd=expression.lastIndexOf(")"),parameters=expression.substring(paramStart,paramEnd),params=splitStyleProperty(parameters),lowerBound=0,upperBound=$previewContainer.width(),args,thisSize,i;for(i=0;i<params.length;i++){args=params[i].split(" ");if(hasLengthInPixels(args)){thisSize=parseFloat(args[1]);upperBound=Math.max(upperBound,thisSize);if(thisSize<0){lowerBound=Math.min(lowerBound,thisSize)}}}lowerBound=Math.abs(lowerBound);upperBound+=lowerBound;for(i=0;i<params.length;i++){args=params[i].split(" ");if(isGradientColorStop(args)&&hasLengthInPixels(args)){if(upperBound===0){thisSize=0}else{thisSize=(parseFloat(args[1])+lowerBound)/upperBound*100}args[1]=thisSize+"%"}params[i]=args.join(" ")}expression=expression.substring(0,paramStart)+params.join(", ")+expression.substring(paramEnd)}return expression}var parensBalanced=areParensBalanced(line),gradientMatch=execGradientMatch(line,parensBalanced),match=gradientMatch.match||execColorMatch(editor,line,pos),cm=editor._codeMirror;while(match){if(pos.ch<match.index){if(gradientMatch.match){gradientMatch={match:null,prefix:"",colorValue:null}}else{break}}else if(pos.ch<=match.index+match[0].length){var previewCSS=gradientMatch.prefix+(gradientMatch.colorValue||match[0]);previewCSS=normalizeGradientExpressionForQuickview(previewCSS);var preview="<div class='color-swatch' style='background:"+previewCSS+"'>"+"</div>";var startPos={line:pos.line,ch:match.index},endPos={line:pos.line,ch:match.index+match[0].length},startCoords=cm.charCoords(startPos),xPos;xPos=(cm.charCoords(endPos).left-startCoords.left)/2+startCoords.left;return{start:startPos,end:endPos,content:preview,xpos:xPos,ytop:startCoords.top,ybot:startCoords.bottom,_previewCSS:previewCSS}}if(gradientMatch.match){gradientMatch=execGradientMatch(line,parensBalanced)}match=gradientMatch.match||execColorMatch(editor,line,pos)}return null}function imagePreviewProvider(editor,pos,token,line){var cm=editor._codeMirror;var urlRegEx=/url\(([^\)]*)\)/gi,tokenString,urlMatch;if(token.type==="string"){tokenString=token.string}else{urlMatch=urlRegEx.exec(line);while(urlMatch){if(pos.ch<urlMatch.index){break}else if(pos.ch<=urlMatch.index+urlMatch[0].length){tokenString=urlMatch[1];break}urlMatch=urlRegEx.exec(line)}}if(!tokenString){return null}tokenString=tokenString.replace(/(^['"])|(['"]$)/g,"");var sPos,ePos;var docPath=editor.document.file.fullPath;var imgPath;var parsed=PathUtils.parseUrl(tokenString);var hasProtocol=parsed.protocol!=="";var ext=parsed.filenameExtension.replace(/^\./,"");var language=LanguageManager.getLanguageForExtension(ext);var id=language&&language.getId();var isImage=id==="image"||id==="svg";if(hasProtocol&&(isImage||!ext&&extensionlessImagePreview)){imgPath=tokenString}else if(!hasProtocol&&isImage){imgPath=BlobUtils.getUrl(Path.join(FileUtils.getDirectoryPath(docPath),tokenString))}if(!imgPath){return null}if(urlMatch){sPos={line:pos.line,ch:urlMatch.index};ePos={line:pos.line,ch:urlMatch.index+urlMatch[0].length}}else{sPos={line:pos.line,ch:token.start};ePos={line:pos.line,ch:token.end}}var imgPreview="<div class='image-preview'>"+'    <img src="'+imgPath+'">'+"</div>";var coord=cm.charCoords(sPos);var xpos=(cm.charCoords(ePos).left-coord.left)/2+coord.left;var showHandler=function(){$previewContainer.hide();$previewContainer.find(".image-preview > img").on("load",function(){$previewContent.append("<div class='img-size'>"+this.naturalWidth+" &times; "+this.naturalHeight+" "+Strings.UNIT_PIXELS+"</div>");$previewContainer.show();positionPreview(editor,popoverState.xpos,popoverState.ytop,popoverState.ybot)}).on("error",function(e){e.preventDefault();hidePreview()})};return{start:sPos,end:ePos,content:imgPreview,onShow:showHandler,xpos:xpos,ytop:coord.top,ybot:coord.bottom,_imgPath:imgPath}}function queryPreviewProviders(editor,pos,token){var line=editor.document.getLine(pos.line);var popover=colorAndGradientPreviewProvider(editor,pos,token,line)||imagePreviewProvider(editor,pos,token,line);if(popover){popover.visible=false;popover.editor=editor;return popover}return null}function getHoveredEditor(mousePos){var fullEditor=EditorManager.getCurrentFullEditor();if(!fullEditor||!mousePos){return}var inlines=fullEditor.getInlineWidgets(),i,editor;for(i=0;i<inlines.length;i++){var $inlineEditorRoot=inlines[i].editor&&$(inlines[i].editor.getRootElement()),$otherDiv=inlines[i].$htmlContent;if($inlineEditorRoot&&divContainsMouse($inlineEditorRoot,mousePos)){editor=inlines[i].editor;break}else if($otherDiv&&divContainsMouse($otherDiv,mousePos)){return}}if(!editor){if(divContainsMouse($(fullEditor.getRootElement()),mousePos)){editor=fullEditor}}return editor}function showPreview(editor,popover){var token,cm;if(!editor){editor=getHoveredEditor(lastMousePos)}if(!editor||!editor._codeMirror){hidePreview();return}cm=editor._codeMirror;var pos=cm.coordsChar({left:lastMousePos.clientX,top:lastMousePos.clientY});if(pos.ch>=editor.document.getLine(pos.line).length){return}if(popover){popoverState=popover}else{token=TokenUtils.getTokenAt(cm,pos);popoverState=$.extend({},popoverState,queryPreviewProviders(editor,pos,token))}if(popoverState&&popoverState.start&&popoverState.end){popoverState.marker=cm.markText(popoverState.start,popoverState.end,{className:"quick-view-highlight"});$previewContent.append(popoverState.content);$previewContainer.show();popoverState.visible=true;if(popoverState.onShow){popoverState.onShow()}else{positionPreview(editor,popoverState.xpos,popoverState.ytop,popoverState.ybot)}}}function processMouseMove(){animationRequest=null;if(!lastMousePos){return}var showImmediately=false,editor=null;if(popoverState&&popoverState.visible){editor=getHoveredEditor(lastMousePos);if(editor&&editor._codeMirror){var cm=editor._codeMirror,pos=cm.coordsChar({left:lastMousePos.clientX,top:lastMousePos.clientY});if(popoverState.start&&popoverState.end&&editor.posWithinRange(pos,popoverState.start,popoverState.end,true)&&pos.ch<editor.document.getLine(pos.line).length){return}}showImmediately=true}hidePreview();popoverState={};popoverState.hoverTimer=window.setTimeout(function(){showPreview(editor)},showImmediately?0:HOVER_DELAY)}function handleMouseMove(event){lastMousePos=null;if(!enabled){return}if(event.which){hidePreview();return}lastMousePos={clientX:event.clientX,clientY:event.clientY};if(!animationRequest){animationRequest=window.requestAnimationFrame(processMouseMove)}}function onActiveEditorChange(event,current,previous){hidePreview();if(previous&&previous.document){previous.document.off("change",hidePreview)}if(current&&current.document){current.document.on("change",hidePreview)}}function updateMenuItemCheckmark(){CommandManager.get(CMD_ENABLE_QUICK_VIEW).setChecked(enabled)}function setExtensionlessImagePreview(_extensionlessImagePreview,doNotSave){if(extensionlessImagePreview!==_extensionlessImagePreview){extensionlessImagePreview=_extensionlessImagePreview;if(!doNotSave){prefs.set("extensionlessImagePreview",enabled);prefs.save()}}}function setEnabled(_enabled,doNotSave){if(enabled!==_enabled){enabled=_enabled;var editorHolder=$("#editor-holder")[0];if(enabled){editorHolder.addEventListener("mousemove",handleMouseMove,true);editorHolder.addEventListener("scroll",hidePreview,true);editorHolder.addEventListener("mouseout",hidePreview,true);onActiveEditorChange(null,EditorManager.getActiveEditor(),null);EditorManager.on("activeEditorChange",onActiveEditorChange)}else{editorHolder.removeEventListener("mousemove",handleMouseMove,true);editorHolder.removeEventListener("scroll",hidePreview,true);editorHolder.removeEventListener("mouseout",hidePreview,true);onActiveEditorChange(null,null,EditorManager.getActiveEditor());EditorManager.off("activeEditorChange",onActiveEditorChange);hidePreview()}if(!doNotSave){prefs.set("enabled",enabled);prefs.save()}}updateMenuItemCheckmark()}function toggleEnableQuickView(){setEnabled(!enabled)}function _forceShow(popover){hidePreview();lastMousePos={clientX:popover.xpos,clientY:Math.floor((popover.ybot+popover.ytop)/2)};showPreview(popover.editor,popover)}$previewContainer=$(previewContainerHTML).appendTo($("body"));$previewContent=$previewContainer.find(".preview-content");ExtensionUtils.loadStyleSheet(module,"QuickView.css");CommandManager.register(Strings.CMD_ENABLE_QUICK_VIEW,CMD_ENABLE_QUICK_VIEW,toggleEnableQuickView);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(CMD_ENABLE_QUICK_VIEW,null,Menus.AFTER,Commands.VIEW_TOGGLE_INSPECTION);PreferencesManager.convertPreferences(module,{enabled:"user quickview.enabled"});setEnabled(prefs.get("enabled"),true);setExtensionlessImagePreview(prefs.get("extensionlessImagePreview"),true);prefs.on("change","enabled",function(){setEnabled(prefs.get("enabled"),true)});prefs.on("change","extensionlessImagePreview",function(){setExtensionlessImagePreview(prefs.get("extensionlessImagePreview"))});exports._queryPreviewProviders=queryPreviewProviders;exports._forceShow=_forceShow});