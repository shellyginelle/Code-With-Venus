define(function(require,exports,module){"use strict";var CommandManager=brackets.getModule("command/CommandManager"),MainViewManager=brackets.getModule("view/MainViewManager"),Commands=brackets.getModule("command/Commands"),Resizer=brackets.getModule("utils/Resizer"),StatusBar=brackets.getModule("widgets/StatusBar");var VERTICAL_ORIENTATION=0,HORIZONTAL_ORIENTATION=1;var _orientation=VERTICAL_ORIENTATION;var detachedWindow;var isReload;var PostMessageTransport=require("lib/PostMessageTransport");var Compatibility=require("lib/compatibility");function init(){if(getBrowserIframe()){return}var result=MainViewManager.getLayoutScheme();if(result.rows===1&&result.columns===1){show(_orientation)}var _panel=$("#second-pane").empty();var iframeConfig={id:"bramble-iframe-browser",frameborder:0};$("<iframe>",iframeConfig).addClass("iframeWidthHeight").appendTo(_panel)}function setOrientation(orientation){if(orientation===VERTICAL_ORIENTATION){_orientation=VERTICAL_ORIENTATION}else if(orientation===HORIZONTAL_ORIENTATION){_orientation=HORIZONTAL_ORIENTATION}}function show(){if(_orientation===VERTICAL_ORIENTATION){CommandManager.execute(Commands.CMD_SPLITVIEW_VERTICAL)}else if(_orientation===HORIZONTAL_ORIENTATION){CommandManager.execute(Commands.CMD_SPLITVIEW_HORIZONTAL)}MainViewManager.setActivePaneId("first-pane")}function update(urlOrHTML){if(!urlOrHTML){return}var iframe=getBrowserIframe();var doc;Compatibility.supportsIFrameHTMLBlobURL(function(err,shouldUseBlobURL){if(err){console.error("[Brackets IFrame-Browser] Unexpected error:",err);return}if(iframe){if(shouldUseBlobURL){iframe.src=urlOrHTML}else{doc=iframe.contentWindow.document.open("text/html","replace");doc.write(urlOrHTML);doc.close()}}var detachedPreview=getDetachedPreview();if(detachedPreview){isReload=true;if(!shouldUseBlobURL){doc=detachedPreview.document.open("text/html","replace");doc.write(urlOrHTML);doc.close()}else{detachedPreview.location.replace(urlOrHTML)}}})}function getBrowserIframe(){return document.getElementById("bramble-iframe-browser")}function detachPreview(){var iframe=getBrowserIframe();if(!iframe){return}PostMessageTransport.reload();var currentURL=iframe.src;detachedWindow=window.open(currentURL,"Preview");return Compatibility.supportsIFrameHTMLBlobURL(function(err,shouldUseBlobURL){if(err){console.error("[Brackets IFrame-Browser] Unexpected error:",err);return}if(!shouldUseBlobURL){var doc=detachedWindow.document.open("text/html","replace");doc.write(iframe.contentWindow.document.documentElement.outerHTML);doc.close()}Resizer.hide("#second-pane");$("#first-pane").addClass("expandEditor");$("#liveDevButton").removeClass("liveDevButtonDetach");$("#liveDevButton").addClass("liveDevButtonAttach");StatusBar.addIndicator("liveDevButtonBox",$("#liveDevButtonBox"),true,"","Click to return preview to current window","mobileViewButtonBox");return detachedWindow})}function getDetachedPreview(){if(detachedWindow&&!detachedWindow.closed){return detachedWindow}}function attachPreview(){var detachedPreview=getDetachedPreview();if(detachedPreview&&isReload){isReload=false;return}if(detachedPreview){detachedPreview.removeEventListener("beforeunload",attachPreview,false);detachedPreview.close()}Resizer.show("#second-pane");$("#liveDevButton").removeClass("liveDevButtonAttach");$("#liveDevButton").addClass("liveDevButtonDetach");$("#first-pane").removeClass("expandEditor");StatusBar.addIndicator("liveDevButtonBox",$("#liveDevButtonBox"),true,"","Click to open preview in separate window","mobileViewButtonBox")}function setListener(){var detachedPreview=getDetachedPreview();if(detachedPreview){detachedPreview.addEventListener("beforeunload",attachPreview,false)}}exports.init=init;exports.update=update;exports.show=show;exports.getBrowserIframe=getBrowserIframe;exports.HORIZONTAL_ORIENTATION=HORIZONTAL_ORIENTATION;exports.VERTICAL_ORIENTATION=VERTICAL_ORIENTATION;exports.setOrientation=setOrientation;exports.getDetachedPreview=getDetachedPreview;exports.attachPreview=attachPreview;exports.detachPreview=detachPreview;exports.setListener=setListener});