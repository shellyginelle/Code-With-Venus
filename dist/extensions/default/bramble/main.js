define(function(require,exports,module){"use strict";var AppInit=brackets.getModule("utils/AppInit"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),LiveDevelopment=brackets.getModule("LiveDevelopment/LiveDevMultiBrowser"),BrambleStartupState=brackets.getModule("bramble/StartupState"),ProjectManager=brackets.getModule("project/ProjectManager"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),FileSystem=brackets.getModule("filesystem/FileSystem"),Browser=require("lib/iframe-browser"),UI=require("lib/UI"),Launcher=require("lib/launcher"),NoHost=require("nohost/main"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),PostMessageTransport=require("lib/PostMessageTransport"),Path=brackets.getModule("filesystem/impls/filer/BracketsFiler").Path,FileSystemCache=brackets.getModule("filesystem/impls/filer/FileSystemCache"),BlobUtils=brackets.getModule("filesystem/impls/filer/BlobUtils"),XHRHandler=require("lib/xhr/XHRHandler"),Theme=require("lib/Theme"),RemoteCommandHandler=require("lib/RemoteCommandHandler"),RemoteEvents=require("lib/RemoteEvents");ExtensionUtils.loadStyleSheet(module,"stylesheets/style.css");ExtensionUtils.loadStyleSheet(module,"stylesheets/sidebarTheme.css");function parseData(data){try{data=JSON.parse(data||null);return data||{}}catch(err){return false}}function handleMessage(message){var currentDocUrl=Browser.getBrowserIframe().src;var currentDocPath=BlobUtils.getFilename(currentDocUrl);var currentDir=currentDocPath!==currentDocUrl?Path.dirname(currentDocPath):currentDocPath;var requestedPath;try{message=parseData(message)}catch(ex){console.error("[Brackets Browser LiveDev Error] Cannot handle message ",message);return}if(message.method==="XMLHttpRequest"){requestedPath=Path.resolve(currentDir,Path.normalize(message.path));XHRHandler.handleRequest(requestedPath)}}function startLiveDev(){Browser.init();var prefs=PreferencesManager.getExtensionPrefs("livedev");prefs.set("multibrowser",true);NoHost.init();PostMessageTransport.setIframe(Browser.getBrowserIframe());LiveDevelopment.setTransport(PostMessageTransport);LiveDevelopment.setLauncher(new Launcher({browser:Browser,server:NoHost.getHTMLServer()}));LiveDevelopment.open()}function finishStartup(err){if(err){console.warn("Unable to preload filesystem URLs",err)}PreferencesManager.set("insertHintOnTab",true);PreferencesManager.set("spaceUnits",2);PreferencesManager.set("tabSize",2);PreferencesManager.set("closeTags",true);PreferencesManager.setViewState("splitview.multipane-info",true);window.addEventListener("message",function(e){var data=parseData(e.data);if(!data){return}var type=data.type;if(type==="message"){handleMessage(data.message);return}else if(type==="themeToggle"){Theme.toggle(data.theme);return}},false);RemoteEvents.loaded()}function loadProject(){var root=BrambleStartupState.project("root");var filename=BrambleStartupState.project("filename");ProjectManager.openProject(root).always(function(){var deferred=new $.Deferred;FileSystem.resolve(filename,function(err,file){if(!err){var promise=CommandManager.execute(Commands.CMD_ADD_TO_WORKINGSET_AND_OPEN,{fullPath:file.fullPath});promise.then(deferred.resolve,deferred.reject)}else{deferred.reject()}});deferred.always(function(){FileSystemCache.refresh(function(err){if(err){console.warn("[Bramble] unable to preload all filesystem Blob URLs",err)}AppInit._dispatchReady(AppInit.APP_READY);startLiveDev();UI.initUI(finishStartup)})})})}function init(e){var data=parseData(e.data);if(!(data&&data.type==="bramble:init")){return}window.removeEventListener("message",init,false);window.addEventListener("message",RemoteCommandHandler.handleRequest,false);BrambleStartupState.project.init({root:data.mount.root,filename:data.mount.filename});BrambleStartupState.ui.init({fontSize:data.state.fontSize,theme:data.state.theme,sidebarVisible:data.state.sidebarVisible,sidebarWidth:data.state.sidebarWidth,firstPaneWidth:data.state.firstPaneWidth,secondPaneWidth:data.state.secondPaneWidth,previewMode:data.state.previewMode,wordWrap:data.state.wordWrap});RemoteEvents.start();loadProject()}window.addEventListener("message",init,false);parent.postMessage(JSON.stringify({type:"bramble:readyToMount"}),"*")});