define(function(require,exports,module){"use strict";var PreferencesManager=brackets.getModule("preferences/PreferencesManager"),HTMLUtils=brackets.getModule("language/HTMLUtils"),prefs=PreferencesManager.getExtensionPrefs("cdn-suggestions"),CDNPrefs=require("modules/prefs"),CDNLibrary=require("modules/CDNLibrary");function CDNHintProvider(libraryList){this.libraryList=libraryList}CDNHintProvider.prototype.hasHints=function(editor,implicitChar){this.editor=editor;var pos=editor.getCursorPos(),tagInfo=HTMLUtils.getTagInfo(editor,pos);if(this.hasLibraryHints(tagInfo)||this.hasVersionHints(tagInfo)){return true}else{return false}};CDNHintProvider.prototype.hasLibraryHints=function(tagInfo){var pos=this.editor.getCursorPos(),tagStartPos=this.editor.document.getLine(pos.line);var result=(tagInfo.tagName==="script"||tagInfo.tagName==="link")&&tagInfo.position.tokenType==="attr.name"&&tagInfo.attr.name.length===0;return result};CDNHintProvider.prototype.hasVersionHints=function(tagInfo){return this.libraryList.findById(tagInfo.attr.name)!==null};CDNHintProvider.prototype.getHints=function(implicitChar){var pos=this.editor.getCursorPos(),tagInfo=HTMLUtils.getTagInfo(this.editor,pos),library=this.libraryList.findById(tagInfo.attr.name);if(tagInfo.position.tokenType!=="attr.name"){return null}if(library===null){return this.getLibraryHints(tagInfo)}else{return this.getVersionHints(library)}};CDNHintProvider.prototype.getLibraryHints=function(tagInfo){var filter=new RegExp(tagInfo.attr.name,"i");var libraryNames=this.libraryList.getLibraryNamesByType(tagInfo.tagName).filter(function(libraryName){return filter.test(libraryName)});if(tagInfo.attr.name.length!==0){libraryNames.sort(compareByStrPos)}function compareAlphabetically(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())}function compareByStrPos(a,b){var difference=filter.exec(a).index-filter.exec(b).index;if(difference===0){return a.localeCompare(b)}else{return difference}}return{hints:libraryNames,match:tagInfo.attr.name,selectInitial:true,handleWideResults:false}};CDNHintProvider.prototype.getVersionHints=function(library){if(library===null){return null}return{hints:library.getVersions(),match:null,selectInitial:true,handleWideResults:false}};CDNHintProvider.prototype.insertHint=function(hint){var pos=this.editor.getCursorPos(),tagInfo=HTMLUtils.getTagInfo(this.editor,pos),library=this.libraryList.findById(tagInfo.attr.name);if(library===null){this.insertLibraryId(hint);return true}else{this.insertLibrarySnippet(hint);return false}};CDNHintProvider.prototype.insertLibraryId=function(hint){var document=this.editor.document,startPos=this.editor.getCursorPos(),tagInfo=HTMLUtils.getTagInfo(this.editor,this.editor.getCursorPos()),library=this.libraryList.findByName(hint),snippet=library.getId();startPos.ch-=tagInfo.attr.name.length;var endPos={line:startPos.line,ch:startPos.ch+snippet.length};document.replaceRange(snippet,startPos,endPos)};CDNHintProvider.prototype.insertLibrarySnippet=function(hint){var document=this.editor.document,startPos=this.editor.getCursorPos(),tagInfo=HTMLUtils.getTagInfo(this.editor,this.editor.getCursorPos()),library=this.libraryList.findById(tagInfo.attr.name),useHTTPS=prefs.get(CDNPrefs.USE_HTTPS.id),snippet=library.getSnippet(hint,useHTTPS);var line=this.editor.document.getLine(startPos.line),tagStart=line.indexOf("<"+tagInfo.tagName);startPos.ch=tagStart;var libraryIdStart=line.indexOf(tagInfo.attr.name,tagStart),libraryIdEnd=libraryIdStart+tagInfo.attr.name.length,endPos={line:startPos.line,ch:libraryIdEnd};document.replaceRange(snippet,startPos,endPos)};exports.CDNHintProvider=CDNHintProvider});